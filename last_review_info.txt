=====================================================================
                         代码审核报告
=====================================================================

审核时间: 2026-01-28 14:02:25

==========

## 一、变更文件列表
- last_review_info.txt

==================================================
## 二、潜在风险分析（针对 iOS 项目）
==================================================

**未发现明显的 iOS / Swift / SwiftUI / Objective-C 项目相关的潜在风险。**

### 原因分析

本次变更文件为 `last_review_info.txt`，这是一个**文本报告文件**，记录了之前某次代码审核的内容，并非 iOS / Swift / SwiftUI / Objective-C 源代码文件。

**不涉及以下 iOS 特定风险：**
- 无强制解包（`!`）
- 无强制类型转换（`as!`）
- 无数组/字典越界访问
- 无 UI 线程更新问题
- 无 SwiftUI 状态管理问题（@State / @Binding / @ObservedObject / @StateObject / @EnvironmentObject）
- 无内存泄漏风险（闭包捕获 self、循环引用）
- 无多线程并发问题（GCD / Swift Concurrency）
- 无 API 使用不当问题
- 无资源释放问题（timer / observer / animation）

==================================================
## 三、语言与框架专项审查要点
==================================================

### 3.1 Swift 语言专项
- 不适用（文件非 Swift 代码）

### 3.2 SwiftUI 专项
- 不适用（文件非 SwiftUI 视图代码）

### 3.3 Objective-C 专项
- 不适用（文件非 Objective-C 代码）

### 3.4 并发模型
- 不适用（文件不涉及多线程代码）

==================================================
## 四、架构与设计层面风险
==================================================

该文件为审核报告文件，不涉及 iOS 项目的架构设计，因此不存在以下风险：
- View / ViewModel / Model 职责混乱
- 业务逻辑写在 View 中
- 可维护性问题
- 命名歧义问题

==================================================
## 五、风险等级判定
==================================================

**未发现任何风险**，因此无需进行风险等级判定。

==================================================
## 六、结论
==================================================

**未发现明显的 iOS / Swift / SwiftUI / Objective-C 项目相关的潜在风险。**

本次变更为更新一个审核报告文件 `last_review_info.txt`，不涉及任何 iOS 应用层代码修改，因此不存在应用层面的 Crash、内存泄漏、性能问题、线程安全等 iOS 特定风险。

=================================================================
                        完整代码变更
=================================================================

diff --git a/last_review_info.txt b/last_review_info.txt
index 9778af0..ab85f51 100644
--- a/last_review_info.txt
+++ b/last_review_info.txt
@@ -2,7 +2,7 @@
                          代码审核报告
 =====================================================================
 
-审核时间: 2026-01-28 14:00:21
+审核时间: 2026-01-28 14:01:48
 
 ==========
 
@@ -14,8 +14,7 @@
 ==================================================
 ## 二、潜在风险分析（针对 iOS 项目）
 ==================================================
-
-本次变更文件为 **`last_review_info.txt`**，这是一个**文本报告文件**，记录了之前某次代码审核的内容，并非 iOS / Swift / SwiftUI / Objective-C 源代码文件。
+本次变更文件为 `last_review_info.txt`，这是一个**文本报告文件**，记录了之前某次代码审核的内容，并非 iOS / Swift / SwiftUI / Objective-C 源代码文件。
 
 **未发现明显的 iOS / Swift / SwiftUI / Objective-C 项目相关的潜在风险。**
 
@@ -54,7 +53,6 @@
 ==================================================
 ## 四、架构与设计层面风险
 ==================================================
-
 该文件为审核报告文件，不涉及 iOS 项目的架构设计，因此不存在以下风险：
 - View / ViewModel / Model 职责混乱
 - 业务逻辑写在 View 中
@@ -64,1004 +62,2013 @@
 ==================================================
 ## 五、风险等级判定
 ==================================================
-
 **未发现任何风险**，因此无需进行风险等级判定。
 
 ==================================================
 ## 六、结论
 ==================================================
-
 **未发现明显的 iOS / Swift / SwiftUI / Objective-C 项目相关的潜在风险。**
 
-本次变更为添加一个审核报告文件 `last_review_info.txt`，不涉及任何 iOS 应用层代码修改，因此不存在应用层面的 Crash、内存泄漏、性能问题、线程安全等 iOS 特定风险。
+本次变更为更新一个审核报告文件 `last_review_info.txt`，不涉及任何 iOS 应用层代码修改，因此不存在应用层面的 Crash、内存泄漏、性能问题、线程安全等 iOS 特定风险。
 
 =================================================================
                         完整代码变更
 =================================================================
 
 diff --git a/last_review_info.txt b/last_review_info.txt
-new file mode 100644
-index 0000000..23c0d9d
---- /dev/null
+index 23c0d9d..9778af0 100644
+--- a/last_review_info.txt
 +++ b/last_review_info.txt
-@@ -0,0 +1,978 @@
-+=====================================================================
-+                         代码审核报告
-+=====================================================================
-+
-+审核时间: 2026-01-28 12:45:20
-+
-+==========
-+
-+# 代码审查报告
-+
-+## 一、变更文件列表
-+- CodeReview/claude_precommit.sh
-+
-+---
-+
-+## 二、潜在风险分析
-+
-+本次变更为一个 **Shell 脚本**，并非 iOS / Swift / Objective-C 代码。根据审查要求，我仅基于 iOS / Swift / SwiftUI / Objective-C 项目相关的风险点进行分析。
-+
-+**未发现明显的 iOS 项目特定风险**，原因如下：
-+
-+1. **语言范围不匹配**：变更文件为 Bash 脚本（`.sh`），不属于 Swift / SwiftUI / Objective-C 代码范畴，因此不存在以下 iOS 特定风险：
-+   - 强制解包（`!`）
-+   - 强制类型转换（`as!`）
-+   - 数组/字典越界访问
-+   - UI 线程问题
-+   - SwiftUI 状态异常
-+   - 循环引用（闭包捕获 self）
-+   - ARC 内存泄漏
-+   - GCD / Swift Concurrency 并发问题
-+   - iOS API 兼容性问题
-+
-+2. **架构设计层面**：本脚本为自动化工具代码，不涉及 iOS 项目的 View / ViewModel / Model 架构设计。
-+
-+---
-+
-+## 三、通用编程风险（非 iOS 专项）
-+
-+虽然不涉及 iOS 特定风险，但从通用编程角度，本脚本存在以下潜在问题（供参考）：
-+
-+### [低] Shell 脚本潜在问题
-+
-+| 风险类型 | 描述 | 严重程度 | 涉及位置 |
-+|---------|------|---------|---------|
-+| 临时文件清理不完整 | 代码中多次清理 `$TEMP_RESULT` 和 `$TEMP_PID`，但异常退出路径可能遗留临时文件 | 低 | 多处 rm 命令 |
-+| AppleScript 嵌入复杂 | 使用 `osascript` 嵌入多行 AppleScript，存在转义和变量传递的潜在风险 | 低 | 第 6-15 行、第 411-451 行 |
-+| 超时处理可能残留进程 | 超时后使用 `kill -9` 强制终止，可能在极少数场景下留下僵尸进程 | 低 | 第 197-198 行 |
-+
-+**注意**：以上为 Shell 脚本通用风险，不属于 iOS 项目审查范畴。
-+
-+---
-+
-+## 四、结论
-+
-+**未发现 iOS / Swift / SwiftUI / Objective-C 项目相关的明显风险。**
-+
-+本次变更仅为 Git pre-commit hook 工具脚本的调整，不涉及任何 iOS 应用层代码，因此不存在应用层面的 Crash、内存泄漏、性能问题、线程安全等 iOS 特定风险。
+@@ -2,977 +2,1066 @@
+                          代码审核报告
+ =====================================================================
+ 
+-审核时间: 2026-01-28 12:45:20
++审核时间: 2026-01-28 14:00:21
+ 
+ ==========
+ 
+-# 代码审查报告
+-
++==================================================
+ ## 一、变更文件列表
+-- CodeReview/claude_precommit.sh
++==================================================
++- last_review_info.txt
 +
-+=================================================================
-+                        完整代码变更
-+=================================================================
++==================================================
++## 二、潜在风险分析（针对 iOS 项目）
++==================================================
 +
-+diff --git a/CodeReview/claude_precommit.sh b/CodeReview/claude_precommit.sh
-+index dbeb03f..390de5a 100755
-+--- a/CodeReview/claude_precommit.sh
-++++ b/CodeReview/claude_precommit.sh
-+@@ -1,56 +1,21 @@
-+ #!/bin/bash
-+ 
-+ # 添加：执行前选择弹窗（放在最前面）
-+-# macOS 弹窗函数
-+-show_macos_dialog() {
-+-  local message="$1"
-+-  local title="$2"
-+-  local buttons="$3"
-+-  local default_button="$4"
-+-
-+-  osascript <<EOF 2>/dev/null
-+-    set theMessage to "$message"
-+-    set theButtons to {$buttons}
-+-    set theResult to display dialog theMessage buttons theButtons default button "$default_button" with title "$title" with icon note
-++# 检测是否是macOS
-++if [[ "$OSTYPE" == "darwin"* ]]; then
-++  # 尝试显示macOS弹窗
-++  CHOICE=$(osascript <<EOF 2>/dev/null
-++    set theResult to display dialog "请选择执行方式：" & return & return & "1. 审核代码 - 分析代码变更并生成审核报告" & return & "2. 直接提交 - 跳过审核直接提交代码" ¬
-++        buttons {"审核代码", "直接提交"} ¬
-++        default button "审核代码" ¬
-++        with title "代码提交 - 执行选择" ¬
-++        with icon note
-+     return button returned of theResult
-+ EOF
-+-  return $?
-+-}
-+-
-+-# 检测操作系统类型（仅 macOS）
-+-IS_MAC=false
-+-if [[ "$OSTYPE" == "darwin"* ]]; then
-+-  IS_MAC=true
-+-fi
-+-
-+-# 检测是否有 GUI 会话（macOS）
-+-HAS_GUI_SESSION=true
-+-if [ "$IS_MAC" = true ]; then
-+-  # 尝试运行 osascript 测试
-+-  if ! osascript -e 'tell application "System Events" to get name of every process' >/dev/null 2>&1; then
-+-    HAS_GUI_SESSION=false
-+-  fi
-+-fi
-+-
-+-# 检测是否在 pre-commit hook 中运行
-+-IS_PRE_COMMIT=false
-+-if [ -n "$GIT_PREFIX" ] || [ -n "$GIT_INDEX_FILE" ]; then
-+-  IS_PRE_COMMIT=true
-+-fi
-+-
-+-# 执行前选择：只在非pre-commit模式下显示，并且有GUI会话
-+-if [ "$IS_PRE_COMMIT" = false ] && [ "$IS_MAC" = true ] && [ "$HAS_GUI_SESSION" = true ]; then
-+-  echo "显示执行前选择弹窗..."
-++  )
-+   
-+-  # 显示执行前选择弹窗
-+-  EXEC_CHOICE=$(show_macos_dialog \
-+-    "请选择执行方式：\n\n1. 审核代码 - 分析代码变更并生成审核报告\n2. 直接提交 - 跳过审核直接提交代码" \
-+-    "代码提交 - 执行选择" \
-+-    "\"审核代码\", \"直接提交\"" \
-+-    "审核代码")
-+-  
-+-  if [ $? -eq 0 ] && [ -n "$EXEC_CHOICE" ]; then
-+-    case "$EXEC_CHOICE" in
-++  if [ $? -eq 0 ] && [ -n "$CHOICE" ]; then
-++    case "$CHOICE" in
-+       "直接提交")
-+         echo "✅ 用户选择直接提交，跳过代码审核"
-+         exit 0
-+@@ -62,8 +27,8 @@ if [ "$IS_PRE_COMMIT" = false ] && [ "$IS_MAC" = true ] && [ "$HAS_GUI_SESSION"
-+   fi
-+ fi
-+ 
-+-# 如果不是macOS或没有GUI，或者是在pre-commit中运行，显示命令行选择
-+-if [ "$IS_PRE_COMMIT" = false ] && { [ "$IS_MAC" = false ] || [ "$HAS_GUI_SESSION" = false ] || [ -z "$EXEC_CHOICE" ]; }; then
-++# 如果弹窗失败或不是macOS，显示命令行选择
-++if [[ "$OSTYPE" != "darwin"* ]] || [ -z "$CHOICE" ]; then
-+   echo "================================================================="
-+   echo "                代码提交 - 执行选择"
-+   echo "================================================================="
-+@@ -74,20 +39,12 @@ if [ "$IS_PRE_COMMIT" = false ] && { [ "$IS_MAC" = false ] || [ "$HAS_GUI_SESSIO
-+   echo "  2) 直接提交 - 跳过审核直接提交代码"
-+   echo ""
-+   
-+-  # 检查标准输入是否可用
-+   if [ -t 0 ]; then
-+     while true; do
-+       printf "你的选择 (1或2): "
-+       read choice
-+       choice=$(echo "$choice" | xargs)
-+ 
-+-      if [ -z "$choice" ]; then
-+-        echo ""
-+-        echo "提示： 请输入 1 或 2，或按 ctrl+c 取消"
-+-        echo ""
-+-        continue
-+-      fi
-+-
-+       case "$choice" in
-+         1|"审核代码")
-+           echo ""
-+@@ -101,26 +58,38 @@ if [ "$IS_PRE_COMMIT" = false ] && { [ "$IS_MAC" = false ] || [ "$HAS_GUI_SESSIO
-+           exit 0
-+           ;;
-+         *)
-+-          echo ""
-+           echo "提示： 请输入 1 或 2"
-+-          echo ""
-+           ;;
-+       esac
-+     done
-+   else
-+-    # 非交互式环境，默认执行审核
-+-    echo "⚠️  非交互式环境，自动执行代码审核"
-++    echo "自动执行代码审核"
-+     echo ""
-+   fi
-+ fi
-+ 
-+-# 如果是pre-commit模式，直接执行审核（不显示选择）
-+-if [ "$IS_PRE_COMMIT" = true ]; then
-+-  echo "pre-commit hook 模式，自动执行代码审核"
-++# 以下是您原来的脚本内容，不做任何修改
-++
-++# 检测是否在 pre-commit hook 中运行
-++IS_PRE_COMMIT=false
-++if [ -n "$GIT_PREFIX" ] || [ -n "$GIT_INDEX_FILE" ]; then
-++  IS_PRE_COMMIT=true
-++fi
-++
-++# 检测操作系统类型（仅 macOS）
-++IS_MAC=false
-++if [[ "$OSTYPE" == "darwin"* ]]; then
-++  IS_MAC=true
-+ fi
-+ 
-+-# 以下是您原来的脚本内容，不做任何修改
-+-echo "🔍 Claude Code 正在审核本次提交..."
-++# 检测是否有 GUI 会话（macOS）
-++HAS_GUI_SESSION=true
-++if [ "$IS_MAC" = true ]; then
-++  # 尝试运行 osascript 测试
-++  if ! osascript -e 'tell application "System Events" to get name of every process' >/dev/null 2>&1; then
-++    HAS_GUI_SESSION=false
-++  fi
-++fi
-+ 
-+ # 检测 git 命令路径
-+ if command -v git &> /dev/null; then
-+@@ -138,6 +107,8 @@ fi
-+ PROJECT_ROOT="$($GIT_CMD rev-parse --show-toplevel)"
-+ cd "$PROJECT_ROOT" || exit 1
-+ 
-++echo "🔍 Claude Code 正在审核本次提交..."
-++
-+ # 设置临时文件路径
-+ TMP_DIR="/tmp"
-+ DIFF_FILE="$TMP_DIR/claude_diff_$$.patch"
-+@@ -151,4 +122,750 @@ if [ ! -s "$DIFF_FILE" ]; then
-+   exit 0
-+ fi
-+ 
-+-# ... [后面所有原有代码保持不变] ...
-++# 设置审核结果输出文件
-++REVIEW_FILE="$PROJECT_ROOT/last_review_info.txt"
-++
-++# 检测项目类型（iOS 或 Android）
-++PROJECT_TYPE=""
-++
-++# 检测 iOS 项目特征
-++IOS_INDICATORS=0
-++if [ -f "$PROJECT_ROOT/Podfile" ]; then
-++  IOS_INDICATORS=$((IOS_INDICATORS + 1))
-++fi
-++if find "$PROJECT_ROOT" -maxdepth 1 -name "*.xcodeproj" -o -name "*.xcworkspace" 2>/dev/null | grep -q .; then
-++  IOS_INDICATORS=$((IOS_INDICATORS + 1))
-++fi
-++if find "$PROJECT_ROOT" -maxdepth 2 -name "Info.plist" 2>/dev/null | grep -q .; then
-++  IOS_INDICATORS=$((IOS_INDICATORS + 1))
-++fi
-++
-++# 检测 Android 项目特征
-++ANDROID_INDICATORS=0
-++if [ -f "$PROJECT_ROOT/build.gradle" ] || [ -f "$PROJECT_ROOT/settings.gradle" ]; then
-++  ANDROID_INDICATORS=$((ANDROID_INDICATORS + 1))
-++fi
-++if [ -f "$PROJECT_ROOT/app/build.gradle" ] || [ -d "$PROJECT_ROOT/app" ]; then
-++  ANDROID_INDICATORS=$((ANDROID_INDICATORS + 1))
-++fi
-++if find "$PROJECT_ROOT" -maxdepth 2 -name "AndroidManifest.xml" 2>/dev/null | grep -q .; then
-++  ANDROID_INDICATORS=$((ANDROID_INDICATORS + 1))
-++fi
-++
-++# 根据指标数量判断项目类型
-++if [ $IOS_INDICATORS -gt $ANDROID_INDICATORS ]; then
-++  PROJECT_TYPE="ios"
-++  echo "📱 检测到 iOS 项目"
-++elif [ $ANDROID_INDICATORS -gt 0 ]; then
-++  PROJECT_TYPE="android"
-++  echo "🤖 检测到 Android 项目"
-++else
-++  # 默认使用 iOS（如果无法检测）
-++  PROJECT_TYPE="ios"
-++  echo "⚠️  无法确定项目类型，默认使用 iOS 审核规则"
-++fi
-++
-++# 根据项目类型设置审核提示词文件
-++if [ "$PROJECT_TYPE" = "ios" ]; then
-++  PROMPT_FILE="$PROJECT_ROOT/CodeReview/claude_prompt_ios.txt"
-++elif [ "$PROJECT_TYPE" = "android" ]; then
-++  PROMPT_FILE="$PROJECT_ROOT/CodeReview/claude_prompt_android.txt"
-++else
-++  PROMPT_FILE="$PROJECT_ROOT/CodeReview/claude_prompt.txt"
-++fi
-++
-++# 获取变更的文件列表
-++CHANGED_FILES=$(grep "^diff --git" "$DIFF_FILE" | sed 's/diff --git a\///' | sed 's/diff --git b\///' | cut -d' ' -f1 | sort | uniq)
-++
-++# 检查提示词文件是否存在，如果不存在则尝试使用默认文件
-++if [ ! -f "$PROMPT_FILE" ]; then
-++  echo "⚠️  提示词文件不存在: $PROMPT_FILE"
-++  
-++  # 尝试使用默认文件
-++  DEFAULT_PROMPT_FILE="$PROJECT_ROOT/CodeReview/claude_prompt.txt"
-++  if [ -f "$DEFAULT_PROMPT_FILE" ]; then
-++    echo "ℹ️  使用默认提示词文件: $DEFAULT_PROMPT_FILE"
-++    PROMPT_FILE="$DEFAULT_PROMPT_FILE"
-++  else
-++    echo "❌ 错误: 提示词文件不存在，且默认文件也不存在"
-++    echo "   请创建以下文件之一："
-++    echo "   - $PROJECT_ROOT/CodeReview/claude_prompt_ios.txt (iOS 项目)"
-++    echo "   - $PROJECT_ROOT/CodeReview/claude_prompt_android.txt (Android 项目)"
-++    echo "   - $PROJECT_ROOT/CodeReview/claude_prompt.txt (通用)"
-++    exit 1
-++  fi
-++fi
-++
-++# 检查 claude 命令是否可用（尝试多个可能的路径）
-++CLAUDE_CMD=""
-++CLAUDE_AVAILABLE=false
-++
-++# 尝试多个可能的 claude 命令路径
-++if command -v claude &> /dev/null; then
-++  CLAUDE_CMD="claude"
-++  CLAUDE_AVAILABLE=true
-++elif [ -f "$HOME/.local/bin/claude" ]; then
-++  CLAUDE_CMD="$HOME/.local/bin/claude"
-++  CLAUDE_AVAILABLE=true
-++elif [ -f "/usr/local/bin/claude" ]; then
-++  CLAUDE_CMD="/usr/local/bin/claude"
-++  CLAUDE_AVAILABLE=true
-++elif [ -f "/opt/homebrew/bin/claude" ]; then
-++  CLAUDE_CMD="/opt/homebrew/bin/claude"
-++  CLAUDE_AVAILABLE=true
-++elif [ -f "$HOME/bin/claude" ]; then
-++  CLAUDE_CMD="$HOME/bin/claude"
-++  CLAUDE_AVAILABLE=true
-++fi
-++
-++# 如果找到了 claude 命令，验证它是否可执行
-++if [ "$CLAUDE_AVAILABLE" = true ] && [ -n "$CLAUDE_CMD" ]; then
-++  if [ ! -x "$CLAUDE_CMD" ] && ! command -v "$CLAUDE_CMD" &> /dev/null; then
-++    CLAUDE_AVAILABLE=false
-++    CLAUDE_CMD=""
-++  fi
-++fi
-++
-++# 调用 claude（带超时处理，默认 60 秒）
-++CLAUDE_TIMEOUT=60
-++CLAUDE_ERROR=false
-++RAW_RESULT=""
-++
-++if [ "$CLAUDE_AVAILABLE" = true ] && [ -n "$CLAUDE_CMD" ]; then
-++  echo "⏳ 正在调用 Claude 进行代码审核（最多等待 ${CLAUDE_TIMEOUT} 秒）..."
-++  echo "   使用命令: $CLAUDE_CMD"
-++  
-++  # 创建临时文件存储结果
-++  TEMP_RESULT=$(mktemp 2>/dev/null || echo "$TMP_DIR/claude_result_$$.txt")
-++  TEMP_PID=$(mktemp 2>/dev/null || echo "$TMP_DIR/claude_pid_$$.txt")
-++  touch "$TEMP_RESULT" "$TEMP_PID"
-++  
-++  # 在后台运行 claude（使用完整路径，并确保环境变量正确）
-++  (
-++    # 确保 PATH 包含常用路径
-++    export PATH="$HOME/.local/bin:/usr/local/bin:/opt/homebrew/bin:$HOME/bin:$PATH"
-++    "$CLAUDE_CMD" <<EOF 2>&1
-++$(cat "$PROMPT_FILE")
-++git diff 内容如下：
-++$(cat "$DIFF_FILE")
-++EOF
-++    echo $? > "$TEMP_PID"
-++  ) > "$TEMP_RESULT" 2>&1 &
-++  
-++  CLAUDE_PID=$!
-++  
-++  # 验证后台进程是否成功启动
-++  sleep 0.5
-++  if ! kill -0 $CLAUDE_PID 2>/dev/null; then
-++    # 进程立即退出了，可能是启动失败
-++    CLAUDE_ERROR=true
-++    echo "⚠️  Claude 进程启动失败，检查错误信息："
-++    if [ -f "$TEMP_RESULT" ]; then
-++      cat "$TEMP_RESULT" | head -20
-++      RAW_RESULT=$(cat "$TEMP_RESULT" 2>/dev/null)
-++    fi
-++    rm -f "$TEMP_RESULT" "$TEMP_PID"
-++  else
-++    # 进程成功启动，等待进程完成或超时
-++    WAIT_COUNT=0
-++    while [ $WAIT_COUNT -lt $CLAUDE_TIMEOUT ]; do
-++      if ! kill -0 $CLAUDE_PID 2>/dev/null; then
-++        # 进程已结束
-++        break
-++      fi
-++      sleep 1
-++      WAIT_COUNT=$((WAIT_COUNT + 1))
-++    done
-++    
-++    # 检查是否超时
-++    if kill -0 $CLAUDE_PID 2>/dev/null; then
-++      # 进程仍在运行，超时了
-++      kill $CLAUDE_PID 2>/dev/null
-++      kill -9 $CLAUDE_PID 2>/dev/null
-++      CLAUDE_ERROR=true
-++      echo "⏱️  Claude 审核超时（${CLAUDE_TIMEOUT} 秒）"
-++      RAW_RESULT=""
-++      rm -f "$TEMP_RESULT" "$TEMP_PID"
-++    else
-++      # 读取结果
-++      RAW_RESULT=$(cat "$TEMP_RESULT" 2>/dev/null)
-++      EXIT_CODE=$(cat "$TEMP_PID" 2>/dev/null || echo "0")
-++      
-++      # 清理临时文件
-++      rm -f "$TEMP_RESULT" "$TEMP_PID"
-++      
-++      # 检查返回码
-++      if [ "$EXIT_CODE" != "0" ]; then
-++        CLAUDE_ERROR=true
-++        echo "❌ Claude 调用失败（退出码: $EXIT_CODE）"
-++        if [ -n "$RAW_RESULT" ]; then
-++          echo "   错误信息: $(echo "$RAW_RESULT" | head -5 | tr '\n' ' ')"
-++        fi
-++      fi
-++      
-++      # 检查结果是否为空或包含错误信息
-++      if [ -z "$RAW_RESULT" ]; then
-++        CLAUDE_ERROR=true
-++        echo "⚠️  Claude 返回了空结果"
-++      elif echo "$RAW_RESULT" | grep -qE "(error|Error|ERROR|EPERM|operation not permitted|timeout|Timeout)" 2>/dev/null; then
-++        # 检查是否是真正的错误（排除正常的审核结果中可能包含这些词）
-++        if echo "$RAW_RESULT" | grep -qE "^\s*\{\"type\":\"result\".*\"is_error\":true" 2>/dev/null; then
-++          CLAUDE_ERROR=true
-++          echo "⚠️  Claude 返回了错误"
-++        fi
-++      fi
-++    fi
-++  fi
-++else
-++  CLAUDE_ERROR=true
-++  echo "❌ Claude 命令不可用"
-++  echo "   尝试的路径："
-++  echo "   - claude (PATH)"
-++  echo "   - $HOME/.local/bin/claude"
-++  echo "   - /usr/local/bin/claude"
-++  echo "   - /opt/homebrew/bin/claude"
-++  echo "   - $HOME/bin/claude"
-++  echo ""
-++  echo "   当前 PATH: $PATH"
-++fi
-++
-++# macOS 弹窗函数 - 修复版本
-++show_macos_dialog() {
-++  local message="$1"
-++  local title="$2"
-++  local buttons="$3"
-++  local default_button="$4"
-++
-++  # 修复：在AppleScript中直接构建消息，避免shell变量替换问题
-++  osascript <<EOF 2>/dev/null
-++    set theMessage to "$message"
-++    set theButtons to {$buttons}
-++    set theResult to display dialog theMessage buttons theButtons default button "$default_button" with title "$title" with icon caution
-++    return button returned of theResult
-++EOF
-++  return $?
-++}
-++
-++# 如果 claude 不可用或出错，询问用户是否继续
-++if [ "$CLAUDE_ERROR" = true ] || [ "$CLAUDE_AVAILABLE" = false ]; then
-++  echo ""
-++  echo "⚠️  Claude 审核服务不可用或出错"
-++  echo ""
-++  
-++  # 使用弹窗询问用户
-++  USER_CHOICE=""
-++  if [ "$IS_MAC" = true ] && [ "$HAS_GUI_SESSION" = true ]; then
-++    # 修复：使用单行消息避免格式问题
-++    USER_CHOICE=$(show_macos_dialog \
-++    "Claude代码审核服务不可用或超时\n原因可能是：\n- Claude服务暂时不可用\n- 网络连接问题\n- 审核超时（超过${CLAUDE_TIMEOUT}秒）\n是否继续提交代码？" \
-++    "代码审核服务异常" \
-++    "\"取消提交\", \"继续提交\"" \
-++    "继续提交")
-++    DIALOG_EXIT_CODE=$?
-++
-++    # 如果弹窗失败，降级到命令行交互
-++    if [ $DIALOG_EXIT_CODE -ne 0 ]; then
-++      echo "⚠️  无法显示弹窗（可能处于无 GUI 环境），使用命令行交互"
-++      USER_CHOICE=""
-++    else
-++      # 清理返回值（去除可能的空白字符）
-++      USER_CHOICE=$(echo "$USER_CHOICE" | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
-++    fi
-++
-++    case "$USER_CHOICE" in
-++      "取消提交")
-++        echo "❌ 用户选择取消提交"
-++        exit 1
-++        ;;
-++      "继续提交")
-++        echo "✅ 用户选择继续提交（跳过审核）"
-++        echo ""
-++        # 清理临时文件
-++        rm -f "$DIFF_FILE" "$TEMP_RESULT" "$TEMP_PID" 2>/dev/null
-++        exit 0
-++        ;;
-++      *)
-++        # 弹窗失败或返回空值，使用命令行交互
-++        echo "================================================================="
-++        echo "Claude 代码审核服务不可用或超时"
-++        echo "================================================================="
-++        echo ""
-++        echo "原因可能是："
-++        echo "  - Claude 服务暂时不可用"
-++        echo "  - 网络连接问题"
-++        echo "  - 审核超时（超过 ${CLAUDE_TIMEOUT} 秒）"
-++        echo ""
-++        echo "是否继续提交代码？"
-++        echo ""
-++        echo "输入命令："
-++        echo "  1) yes  - 继续提交（跳过审核）"
-++        echo "  2) no   - 取消提交"
-++        echo ""
-++
-++        while true; do
-++          printf "你的选择 (yes/no): "
-++          read choice
-++          choice=$(echo "$choice" | xargs)
-++
-++          if [ -z "$choice" ]; then
-++            echo ""
-++            echo "提示： 请输入 yes 或 no， 或按 ctrl+c 取消"
-++            echo ""
-++            continue
-++          fi
-++
-++          case "$choice" in
-++            yes|y|Y|YES)
-++              echo ""
-++              echo "✅ 继续提交（跳过审核）"
-++              echo ""
-++              # 清理临时文件
-++              rm -f "$DIFF_FILE" "$TEMP_RESULT" "$TEMP_PID" 2>/dev/null
-++              exit 0
-++              ;;
-++            no|n|N|NO)
-++              echo ""
-++              echo "❌ 取消提交"
-++              exit 1
-++              ;;
-++            *)
-++              echo ""
-++              echo "提示： 请输入 yes 或 no， 或按 ctrl+c 取消"
-++              echo ""
-++              ;;
-++          esac
-++        done
-++        ;;
-++    esac
-++  else
-++    # 非 macOS 系统，使用命令行交互
-++    echo "================================================================="
-++    echo "Claude 代码审核服务不可用或超时"
-++    echo "================================================================="
-++    echo ""
-++    echo "原因可能是："
-++    echo "  - Claude 服务暂时不可用"
-++    echo "  - 网络连接问题"
-++    echo "  - 审核超时（超过 ${CLAUDE_TIMEOUT} 秒）"
-++    echo ""
-++    echo "是否继续提交代码？"
-++    echo ""
-++    echo "输入命令："
-++    echo "  1) yes  - 继续提交（跳过审核）"
-++    echo "  2) no   - 取消提交"
-++    echo ""
-++    
-++    while true; do
-++      printf "你的选择 (yes/no): "
-++      read choice
-++      choice=$(echo "$choice" | xargs)
-++
-++      if [ -z "$choice" ]; then
-++        echo ""
-++        echo "提示： 请输入 yes 或 no， 或按 ctrl+c 取消"
-++        echo ""
-++        continue
-++      fi
-++
-++      case "$choice" in
-++        yes|y|Y|YES)
-++          echo ""
-++          echo "✅ 继续提交（跳过审核）"
-++          echo ""
-++          # 清理临时文件
-++          rm -f "$DIFF_FILE" "$TEMP_RESULT" "$TEMP_PID" 2>/dev/null
-++          exit 0
-++          ;;
-++        no|n|N|NO)
-++          echo ""
-++          echo "❌ 取消提交"
-++          exit 1
-++          ;;
-++        *)
-++          echo ""
-++          echo "提示： 请输入 yes 或 no， 或按 ctrl+c 取消"
-++          echo ""
-++          ;;
-++      esac
-++    done
-++  fi
-++fi
-++
-++# 过滤掉 diff 命令的错误信息和 JSON，但保留有用的内容
-++CLEAN_RESULT=$(echo "$RAW_RESULT" || true) || true
-++
-++# 将审核结果写入 last_review_info.txt
-++echo "=====================================================================" > "$REVIEW_FILE"
-++echo "                         代码审核报告" >> "$REVIEW_FILE"
-++echo "=====================================================================" >> "$REVIEW_FILE"
-++echo "" >> "$REVIEW_FILE"
-++echo "审核时间: $(date '+%Y-%m-%d %H:%M:%S')" >> "$REVIEW_FILE"
-++echo "" >> "$REVIEW_FILE"
-++echo "==========" >> "$REVIEW_FILE"
-++echo "" >> "$REVIEW_FILE"
-++
-++# 检查是否有审核结果
-++if [ -n "$CLEAN_RESULT" ]; then
-++  echo "$CLEAN_RESULT" >> "$REVIEW_FILE"
-++else
-++  echo "注意：Claude 审核服务暂时不可用，以下是本次提交的变更信息：" >> "$REVIEW_FILE"
-++  echo "" >> "$REVIEW_FILE"
-++  echo "## 变更文件" >> "$REVIEW_FILE"
-++  echo "" >> "$REVIEW_FILE"
-++  echo "$CHANGED_FILES" | while read file; do
-++    echo "- $file" >> "$REVIEW_FILE"
-++  done
-++  echo "" >> "$REVIEW_FILE"
-++  echo "## 潜在风险分析" >> "$REVIEW_FILE"
-++  echo "" >> "$REVIEW_FILE"
-++  echo "由于审核服务暂时不可用，请人工检查以下风险点：" >> "$REVIEW_FILE"
-++  echo "- 数组越界访问" >> "$REVIEW_FILE"
-++  echo "- 强制解包 nil 值" >> "$REVIEW_FILE"
-++  echo "- 内存泄漏" >> "$REVIEW_FILE"
-++  echo "- 主线程耗时操作" >> "$REVIEW_FILE"
-++fi
-++
-++# 在报告末尾添加完整的 git diff（供查看详情时使用）
-++echo "" >> "$REVIEW_FILE"
-++echo "=================================================================" >> "$REVIEW_FILE"
-++echo "                        完整代码变更" >> "$REVIEW_FILE"
-++echo "=================================================================" >> "$REVIEW_FILE"
-++echo "" >> "$REVIEW_FILE"
-++cat "$DIFF_FILE" >> "$REVIEW_FILE"
-++
-++echo "" >> "$REVIEW_FILE"
-++echo "=================================================================" >> "$REVIEW_FILE"
-++
-++echo "✅ 审核完成，已生成报告文件: last_review_info.txt"
-++echo ""
-++
-++# 修复：更智能的风险统计方法
-++# 首先提取所有风险描述块
-++RISK_BLOCKS=$(echo "$CLEAN_RESULT" | grep -n "风险描述" | cut -d: -f1)
-++
-++# 初始化计数器
-++RISK_COUNT=0
-++HIGH_RISK_COUNT=0
-++MEDIUM_RISK_COUNT=0
-++LOW_RISK_COUNT=0
-++
-++# 如果有风险描述，进行详细统计
-++if [ -n "$RISK_BLOCKS" ]; then
-++    # 计算风险总数
-++    RISK_COUNT=$(echo "$RISK_BLOCKS" | wc -l)
-++    
-++    # 统计每种风险类型
-++    HIGH_RISK_COUNT=$(echo "$CLEAN_RESULT" | grep -A5 "风险描述" | grep -c "严重程度.*高\|高风险")
-++    MEDIUM_RISK_COUNT=$(echo "$CLEAN_RESULT" | grep -A5 "风险描述" | grep -c "严重程度.*中\|中风险")
-++    LOW_RISK_COUNT=$(echo "$CLEAN_RESULT" | grep -A5 "风险描述" | grep -c "严重程度.*低\|低风险")
-++    
-++    # 如果还有其他风险（未明确分类的），都归为中风险
-++    UNCERTAIN_RISK_COUNT=$((RISK_COUNT - HIGH_RISK_COUNT - MEDIUM_RISK_COUNT - LOW_RISK_COUNT))
-++    if [ $UNCERTAIN_RISK_COUNT -gt 0 ]; then
-++        MEDIUM_RISK_COUNT=$((MEDIUM_RISK_COUNT + UNCERTAIN_RISK_COUNT))
-++    fi
-++else
-++    # 如果没有明确的风险描述，尝试其他统计方法
-++    RISK_COUNT=$(echo "$CLEAN_RESULT" | grep -c "风险描述\|风险提示\|发现.*风险\|潜在问题")
-++    
-++    # 如果没有找到任何风险，设置为0
-++    if [ -z "$RISK_COUNT" ] || [ "$RISK_COUNT" -eq 0 ]; then
-++        RISK_COUNT=0
-++        HIGH_RISK_COUNT=0
-++        MEDIUM_RISK_COUNT=0
-++        LOW_RISK_COUNT=0
-++    else
-++        # 如果有风险但没有明确分类，假设都是中风险
-++        MEDIUM_RISK_COUNT=$RISK_COUNT
-++    fi
-++fi
-++
-++# 确保所有值都是数字
-++RISK_COUNT=$((RISK_COUNT))
-++HIGH_RISK_COUNT=$((HIGH_RISK_COUNT))
-++MEDIUM_RISK_COUNT=$((MEDIUM_RISK_COUNT))
-++LOW_RISK_COUNT=$((LOW_RISK_COUNT))
-++
-++# 修复：文件数统计
-++FILE_COUNT=$(echo "$CHANGED_FILES" | wc -w)
-++FILE_COUNT=$((FILE_COUNT))
-++
-++# 调试：显示统计值
-++echo "调试信息 - 风险统计:"
-++echo "  总风险数: $RISK_COUNT"
-++echo "  高风险数: $HIGH_RISK_COUNT"
-++echo "  中风险数: $MEDIUM_RISK_COUNT"
-++echo "  低风险数: $LOW_RISK_COUNT"
-++echo "  变更文件数: $FILE_COUNT"
-++
-++# 初始化用户选择变量
-++CHOICE=""
-++
-++# 修复：专门的审核结果弹窗函数
-++if [ "$IS_MAC" = true ] && [ "$HAS_GUI_SESSION" = true ]; then
-++  # 直接在AppleScript中构建完整消息
-++  CHOICE=$(osascript <<EOF 2>/dev/null
-++    set fileCount to "$FILE_COUNT"
-++    set riskCount to "$RISK_COUNT"
-++    set highRisk to "$HIGH_RISK_COUNT"
-++    set mediumRisk to "$MEDIUM_RISK_COUNT"
-++    set lowRisk to "$LOW_RISK_COUNT"
-++    
-++    -- 清理变量值（确保是纯数字）
-++    set fileCount to (do shell script "echo '" & fileCount & "' | tr -cd '0-9'")
-++    set riskCount to (do shell script "echo '" & riskCount & "' | tr -cd '0-9'")
-++    set highRisk to (do shell script "echo '" & highRisk & "' | tr -cd '0-9'")
-++    set mediumRisk to (do shell script "echo '" & mediumRisk & "' | tr -cd '0-9'")
-++    set lowRisk to (do shell script "echo '" & lowRisk & "' | tr -cd '0-9'")
-++    
-++    -- 如果为空则设为0
-++    if fileCount is "" then set fileCount to "0"
-++    if riskCount is "" then set riskCount to "0"
-++    if highRisk is "" then set highRisk to "0"
-++    if mediumRisk is "" then set mediumRisk to "0"
-++    if lowRisk is "" then set lowRisk to "0"
-++    
-++    -- 验证风险总数等于各类风险之和
-++    set totalRisks to (highRisk as integer) + (mediumRisk as integer) + (lowRisk as integer)
-++    if totalRisks ≠ (riskCount as integer) then
-++        -- 如果不匹配，调整风险总数
-++        set riskCount to (totalRisks as string)
-++    end if
-++    
-++    -- 构建消息
-++    set msgLines to {}
-++    set end of msgLines to "代码审核完成"
-++    set end of msgLines to "变更文件数: " & fileCount
-++    set end of msgLines to "发现风险数: " & riskCount
-++    
-++    if (highRisk as integer) > 0 then
-++        set end of msgLines to "  - 高风险: " & highRisk
-++    end if
-++    
-++    if (mediumRisk as integer) > 0 then
-++        set end of msgLines to "  - 中风险: " & mediumRisk
-++    end if
-++    
-++    if (lowRisk as integer) > 0 then
-++        set end of msgLines to "  - 低风险: " & lowRisk
-++    end if
-++    
-++    -- 如果没有找到风险类型，显示一个通用提示
-++    if (highRisk as integer) = 0 and (mediumRisk as integer) = 0 and (lowRisk as integer) = 0 and (riskCount as integer) > 0 then
-++        set end of msgLines to "  - 请查看详细报告了解风险分类"
-++    end if
-++    
-++    set end of msgLines to "审核报告已保存到: last_review_info.txt"
-++    
-++    -- 合并所有行
-++    set AppleScript's text item delimiters to return
-++    set theMessage to msgLines as text
-++    set AppleScript's text item delimiters to ""
-++    
-++    set theResult to display dialog theMessage ¬
-++        buttons {"查看详情", "取消提交", "继续提交"} ¬
-++        default button "查看详情" ¬
-++        with title "代码审核结果" ¬
-++        with icon caution
-++    return button returned of theResult
-++EOF
-++  )
-++  DIALOG_EXIT_CODE=$?
-++
-++  # 如果 osascript 失败（无 GUI 环境），降级到命令行交互
-++  if [ $DIALOG_EXIT_CODE -ne 0 ] || [ -z "$CHOICE" ]; then
-++    echo "⚠️  无法显示弹窗（可能处于无 GUI 环境），使用命令行交互"
-++    CHOICE=""
-++  fi
-++fi
-++
-++# 如果弹窗成功，处理用户选择
-++if [ -n "$CHOICE" ]; then
-++    case "$CHOICE" in
-++      "继续提交"|*"继续提交"*)
-++        echo ""
-++        echo "✅ 已批准提交"
-++        echo ""
-++        exit 0
-++        ;;
-++      "取消提交"|*"取消提交"*)
-++        echo ""
-++        echo "❌ 已阻断提交"
-++        echo ""
-++        echo "请修复问题后重新提交"
-++        exit 1
-++        ;;
-++      "查看详情")
-++        # 打开审核报告文件（macOS）
-++        if [ "$IS_MAC" = true ]; then
-++          open "$REVIEW_FILE"
-++        else
-++          # Linux 使用 xdg-open
-++          xdg-open "$REVIEW_FILE" 2>/dev/null || echo "请手动打开文件: $REVIEW_FILE"
-++        fi
-++        echo ""
-++        echo "已打开审核报告，请查看后决定是否提交"
-++        
-++        # 等待一小段时间，确保文件已打开
-++        sleep 1
-++        
-++        # 重新显示弹窗，让用户选择是否提交
-++        if [ "$IS_MAC" = true ] && [ "$HAS_GUI_SESSION" = true ]; then
-++          FINAL_CHOICE=$(show_macos_dialog \
-++          "审核报告已打开\n请查看 last_review_info.txt 文件后，决定是否继续提交代码" \
-++          "代码审核 - 确认提交" \
-++          "\"取消提交\", \"继续提交\"" \
-++          "继续提交")
-++        else
-++          FINAL_CHOICE=""
-++        fi
-++        
-++        # 处理最终选择
-++        case "$FINAL_CHOICE" in
-++          "继续提交"|*"继续提交"*)
-++            echo ""
-++            echo "✅ 已批准提交"
-++            echo ""
-++            exit 0
-++            ;;
-++          "取消提交"|*"取消提交"*)
-++            echo ""
-++            echo "❌ 已阻断提交"
-++            echo ""
-++            echo "请修复问题后重新提交"
-++            exit 1
-++            ;;
-++          *)
-++            # 如果弹窗失败，降级到命令行交互
-++            echo ""
-++            echo "⚠️  弹窗显示失败，使用命令行交互"
-++            echo ""
-++            echo "================================================================="
-++            echo "请查看审核报告 last_review_info.txt，然后决定是否继续提交："
-++            echo "================================================================="
-++            echo ""
-++            echo "输入命令："
-++            echo "  1) yes  - 继续提交（审核报告将保留）"
-++            echo "  2) no   - 阻断提交（审核报告将保留）"
-++            echo ""
-++
-++            # 询问用户决定
-++            while true; do
-++              printf "你的选择 (yes/no): "
-++      read choice
-++              # 去除首尾空格
-++              choice=$(echo "$choice" | xargs)
-++              
-++              # 如果输入为空，跳过本次循环
-++              if [ -z "$choice" ]; then
-++                echo ""
-++                echo "提示： 请输入 yes 或 no， 或按 ctrl+c 取消"
-++                echo ""
-++                continue
-++              fi
-++              
-++              case "$choice" in
-++                yes|y|Y|YES)
-++                  echo ""
-++                  echo "✅ 已批准提交"
-++                  echo ""
-++                  exit 0
-++                  ;;
-++                no|n|N|NO)
-++                  echo ""
-++                  echo "❌ 已阻断提交"
-++                  echo ""
-++                  echo "请修复问题后重新提交"
-++                  exit 1
-++                  ;;
-++                *)
-++                  echo "提示： 请输入 yes 或 no， 或按 ctrl+c 取消"
-++                  echo ""
-++                  ;;
-++              esac
-++            done
-++            ;;
-++        esac
-++        ;;
-++      *)
-++        echo ""
-++        echo "❌ 已取消操作"
-++        exit 1
-++        ;;
-++    esac
-++fi
-++
-++# 如果弹窗失败或未选择，使用命令行交互
-++if [ -z "$CHOICE" ]; then
-++  # 检查标准输入是否可用（是否是交互式终端）
-++  if [ ! -t 0 ]; then
-++    echo ""
-++    echo "⚠️  标准输入不可用，无法使用命令行交互"
-++    echo ""
-++    echo "请手动检查审核报告: $REVIEW_FILE"
-++    echo ""
-++    
-++    # 如果设置了允许非交互式提交的环境变量，则允许提交
-++    if [ "$ALLOW_NONINTERACTIVE_COMMIT" = "1" ]; then
-++      echo "✅ 检测到 ALLOW_NONINTERACTIVE_COMMIT=1，允许非交互式提交"
-++      exit 0
-++    else
-++      echo "如需继续提交，请使用以下命令之一："
-++      echo "  1) ALLOW_NONINTERACTIVE_COMMIT=1 git commit -m \"your message\""
-++      echo "  2) git -c core.hooksPath=/dev/null commit -m \"your message\"  (临时禁用 hook)"
-++      echo ""
-++      echo "❌ 阻断提交（标准输入不可用）"
-++      exit 1
-++    fi
-++  fi
-++
-++  echo ""
-++  echo "================================================================="
-++  echo "请查看审核报告 last_review_info.txt，然后决定是否继续提交："
-++  echo "================================================================="
-++  echo ""
-++  echo "输入命令："
-++  echo "  1) yes  - 继续提交（审核报告将保留）"
-++  echo "  2) no   - 阻断提交（审核报告将保留）"
-++  echo ""
-++
-++  # 询问用户决定
-++  while true; do
-++    printf "你的选择 (yes/no): "
-++    read choice
-++    # 去除首尾空格
-++    choice=$(echo "$choice" | xargs)
-++
-++    # 如果输入为空，跳过本次循环
-++    if [ -z "$choice" ]; then
-++      echo ""
-++      echo "提示： 请输入 yes 或 no， 或按 ctrl+c 取消"
-++      echo ""
-++      continue
-++    fi
-++
-++    case "$choice" in
-++      yes|y|Y|YES)
-++        echo ""
-++        echo "✅ 已批准提交"
-++        echo ""
-++        exit 0
-++        ;;
-++      no|n|N|NO)
-++        echo ""
-++        echo "❌ 已阻断提交"
-++        echo ""
-++        echo "请修复问题后重新提交"
-++        exit 1
-++        ;;
-++      *)
-++        echo ""
-++        echo "提示： 请输入 yes 或 no， 或按 ctrl+c 取消"
-++        echo ""
-++        ;;
-++    esac
-++  done
-++fi
-++
-++# 清理临时文件
-++rm -f "$DIFF_FILE" "$TEMP_RESULT" "$TEMP_PID"
++本次变更文件为 **`last_review_info.txt`**，这是一个**文本报告文件**，记录了之前某次代码审核的内容，并非 iOS / Swift / SwiftUI / Objective-C 源代码文件。
 +
-+=================================================================
++**未发现明显的 iOS / Swift / SwiftUI / Objective-C 项目相关的潜在风险。**
+ 
+----
++**原因如下：**
+ 
+-## 二、潜在风险分析
++1. **文件类型不属于代码范畴**：`last_review_info.txt` 是纯文本文件，包含审核报告和 git diff 内容，不包含任何可执行的 Swift / SwiftUI / Objective-C 代码。
+ 
+-本次变更为一个 **Shell 脚本**，并非 iOS / Swift / Objective-C 代码。根据审查要求，我仅基于 iOS / Swift / SwiftUI / Objective-C 项目相关的风险点进行分析。
++2. **不涉及 iOS 特定风险类型**：
++   - 无强制解包（`!`）
++   - 无强制类型转换（`as!`）
++   - 无数组/字典越界访问
++   - 无 UI 线程更新问题
++   - 无 SwiftUI 状态管理问题
++   - 无内存泄漏风险
++   - 无多线程并发问题
++   - 无 API 使用不当问题
+ 
+-**未发现明显的 iOS 项目特定风险**，原因如下：
++3. **文件内容为历史审核报告**：该文件记录的是对 `CodeReview/claude_precommit.sh`（一个 Shell 脚本）的审核结果，而非 iOS 应用代码。
+ 
+-1. **语言范围不匹配**：变更文件为 Bash 脚本（`.sh`），不属于 Swift / SwiftUI / Objective-C 代码范畴，因此不存在以下 iOS 特定风险：
+-   - 强制解包（`!`）
+-   - 强制类型转换（`as!`）
+-   - 数组/字典越界访问
+-   - UI 线程问题
+-   - SwiftUI 状态异常
+-   - 循环引用（闭包捕获 self）
+-   - ARC 内存泄漏
+-   - GCD / Swift Concurrency 并发问题
+-   - iOS API 兼容性问题
++==================================================
++## 三、语言与框架专项审查要点
++==================================================
+ 
+-2. **架构设计层面**：本脚本为自动化工具代码，不涉及 iOS 项目的 View / ViewModel / Model 架构设计。
++### 3.1 Swift 语言专项
++- 不适用（文件非 Swift 代码）
+ 
+----
++### 3.2 SwiftUI 专项
++- 不适用（文件非 SwiftUI 视图代码）
+ 
+-## 三、通用编程风险（非 iOS 专项）
++### 3.3 Objective-C 专项
++- 不适用（文件非 Objective-C 代码）
+ 
+-虽然不涉及 iOS 特定风险，但从通用编程角度，本脚本存在以下潜在问题（供参考）：
++### 3.4 并发模型
++- 不适用（文件不涉及多线程代码）
+ 
+-### [低] Shell 脚本潜在问题
++==================================================
++## 四、架构与设计层面风险
++==================================================
+ 
+-| 风险类型 | 描述 | 严重程度 | 涉及位置 |
+-|---------|------|---------|---------|
+-| 临时文件清理不完整 | 代码中多次清理 `$TEMP_RESULT` 和 `$TEMP_PID`，但异常退出路径可能遗留临时文件 | 低 | 多处 rm 命令 |
+-| AppleScript 嵌入复杂 | 使用 `osascript` 嵌入多行 AppleScript，存在转义和变量传递的潜在风险 | 低 | 第 6-15 行、第 411-451 行 |
+-| 超时处理可能残留进程 | 超时后使用 `kill -9` 强制终止，可能在极少数场景下留下僵尸进程 | 低 | 第 197-198 行 |
++该文件为审核报告文件，不涉及 iOS 项目的架构设计，因此不存在以下风险：
++- View / ViewModel / Model 职责混乱
++- 业务逻辑写在 View 中
++- 可维护性问题
++- 命名歧义问题
+ 
+-**注意**：以上为 Shell 脚本通用风险，不属于 iOS 项目审查范畴。
++==================================================
++## 五、风险等级判定
++==================================================
+ 
+----
++**未发现任何风险**，因此无需进行风险等级判定。
+ 
+-## 四、结论
++==================================================
++## 六、结论
++==================================================
+ 
+-**未发现 iOS / Swift / SwiftUI / Objective-C 项目相关的明显风险。**
++**未发现明显的 iOS / Swift / SwiftUI / Objective-C 项目相关的潜在风险。**
+ 
+-本次变更仅为 Git pre-commit hook 工具脚本的调整，不涉及任何 iOS 应用层代码，因此不存在应用层面的 Crash、内存泄漏、性能问题、线程安全等 iOS 特定风险。
++本次变更为添加一个审核报告文件 `last_review_info.txt`，不涉及任何 iOS 应用层代码修改，因此不存在应用层面的 Crash、内存泄漏、性能问题、线程安全等 iOS 特定风险。
+ 
+ =================================================================
+                         完整代码变更
+ =================================================================
+ 
+-diff --git a/CodeReview/claude_precommit.sh b/CodeReview/claude_precommit.sh
+-index dbeb03f..390de5a 100755
+---- a/CodeReview/claude_precommit.sh
+-+++ b/CodeReview/claude_precommit.sh
+-@@ -1,56 +1,21 @@
+- #!/bin/bash
+- 
+- # 添加：执行前选择弹窗（放在最前面）
+--# macOS 弹窗函数
+--show_macos_dialog() {
+--  local message="$1"
+--  local title="$2"
+--  local buttons="$3"
+--  local default_button="$4"
+--
+--  osascript <<EOF 2>/dev/null
+--    set theMessage to "$message"
+--    set theButtons to {$buttons}
+--    set theResult to display dialog theMessage buttons theButtons default button "$default_button" with title "$title" with icon note
+-+# 检测是否是macOS
+-+if [[ "$OSTYPE" == "darwin"* ]]; then
+-+  # 尝试显示macOS弹窗
+-+  CHOICE=$(osascript <<EOF 2>/dev/null
+-+    set theResult to display dialog "请选择执行方式：" & return & return & "1. 审核代码 - 分析代码变更并生成审核报告" & return & "2. 直接提交 - 跳过审核直接提交代码" ¬
+-+        buttons {"审核代码", "直接提交"} ¬
+-+        default button "审核代码" ¬
+-+        with title "代码提交 - 执行选择" ¬
+-+        with icon note
+-     return button returned of theResult
+- EOF
+--  return $?
+--}
+--
+--# 检测操作系统类型（仅 macOS）
+--IS_MAC=false
+--if [[ "$OSTYPE" == "darwin"* ]]; then
+--  IS_MAC=true
+--fi
+--
+--# 检测是否有 GUI 会话（macOS）
+--HAS_GUI_SESSION=true
+--if [ "$IS_MAC" = true ]; then
+--  # 尝试运行 osascript 测试
+--  if ! osascript -e 'tell application "System Events" to get name of every process' >/dev/null 2>&1; then
+--    HAS_GUI_SESSION=false
+--  fi
+--fi
+--
+--# 检测是否在 pre-commit hook 中运行
+--IS_PRE_COMMIT=false
+--if [ -n "$GIT_PREFIX" ] || [ -n "$GIT_INDEX_FILE" ]; then
+--  IS_PRE_COMMIT=true
+--fi
+--
+--# 执行前选择：只在非pre-commit模式下显示，并且有GUI会话
+--if [ "$IS_PRE_COMMIT" = false ] && [ "$IS_MAC" = true ] && [ "$HAS_GUI_SESSION" = true ]; then
+--  echo "显示执行前选择弹窗..."
+-+  )
+-   
+--  # 显示执行前选择弹窗
+--  EXEC_CHOICE=$(show_macos_dialog \
+--    "请选择执行方式：\n\n1. 审核代码 - 分析代码变更并生成审核报告\n2. 直接提交 - 跳过审核直接提交代码" \
+--    "代码提交 - 执行选择" \
+--    "\"审核代码\", \"直接提交\"" \
+--    "审核代码")
+--  
+--  if [ $? -eq 0 ] && [ -n "$EXEC_CHOICE" ]; then
+--    case "$EXEC_CHOICE" in
+-+  if [ $? -eq 0 ] && [ -n "$CHOICE" ]; then
+-+    case "$CHOICE" in
+-       "直接提交")
+-         echo "✅ 用户选择直接提交，跳过代码审核"
+-         exit 0
+-@@ -62,8 +27,8 @@ if [ "$IS_PRE_COMMIT" = false ] && [ "$IS_MAC" = true ] && [ "$HAS_GUI_SESSION"
+-   fi
+- fi
+- 
+--# 如果不是macOS或没有GUI，或者是在pre-commit中运行，显示命令行选择
+--if [ "$IS_PRE_COMMIT" = false ] && { [ "$IS_MAC" = false ] || [ "$HAS_GUI_SESSION" = false ] || [ -z "$EXEC_CHOICE" ]; }; then
+-+# 如果弹窗失败或不是macOS，显示命令行选择
+-+if [[ "$OSTYPE" != "darwin"* ]] || [ -z "$CHOICE" ]; then
+-   echo "================================================================="
+-   echo "                代码提交 - 执行选择"
+-   echo "================================================================="
+-@@ -74,20 +39,12 @@ if [ "$IS_PRE_COMMIT" = false ] && { [ "$IS_MAC" = false ] || [ "$HAS_GUI_SESSIO
+-   echo "  2) 直接提交 - 跳过审核直接提交代码"
+-   echo ""
+-   
+--  # 检查标准输入是否可用
+-   if [ -t 0 ]; then
+-     while true; do
+-       printf "你的选择 (1或2): "
+-       read choice
+-       choice=$(echo "$choice" | xargs)
+- 
+--      if [ -z "$choice" ]; then
+--        echo ""
+--        echo "提示： 请输入 1 或 2，或按 ctrl+c 取消"
+--        echo ""
+--        continue
+--      fi
+--
+-       case "$choice" in
+-         1|"审核代码")
+-           echo ""
+-@@ -101,26 +58,38 @@ if [ "$IS_PRE_COMMIT" = false ] && { [ "$IS_MAC" = false ] || [ "$HAS_GUI_SESSIO
+-           exit 0
+-           ;;
+-         *)
+--          echo ""
+-           echo "提示： 请输入 1 或 2"
+--          echo ""
+-           ;;
+-       esac
+-     done
+-   else
+--    # 非交互式环境，默认执行审核
+--    echo "⚠️  非交互式环境，自动执行代码审核"
+-+    echo "自动执行代码审核"
+-     echo ""
+-   fi
+- fi
+- 
+--# 如果是pre-commit模式，直接执行审核（不显示选择）
+--if [ "$IS_PRE_COMMIT" = true ]; then
+--  echo "pre-commit hook 模式，自动执行代码审核"
+-+# 以下是您原来的脚本内容，不做任何修改
+-+
+-+# 检测是否在 pre-commit hook 中运行
+-+IS_PRE_COMMIT=false
+-+if [ -n "$GIT_PREFIX" ] || [ -n "$GIT_INDEX_FILE" ]; then
+-+  IS_PRE_COMMIT=true
+-+fi
+-+
+-+# 检测操作系统类型（仅 macOS）
+-+IS_MAC=false
+-+if [[ "$OSTYPE" == "darwin"* ]]; then
+-+  IS_MAC=true
+- fi
+- 
+--# 以下是您原来的脚本内容，不做任何修改
+--echo "🔍 Claude Code 正在审核本次提交..."
+-+# 检测是否有 GUI 会话（macOS）
+-+HAS_GUI_SESSION=true
+-+if [ "$IS_MAC" = true ]; then
+-+  # 尝试运行 osascript 测试
+-+  if ! osascript -e 'tell application "System Events" to get name of every process' >/dev/null 2>&1; then
+-+    HAS_GUI_SESSION=false
+-+  fi
+-+fi
+- 
+- # 检测 git 命令路径
+- if command -v git &> /dev/null; then
+-@@ -138,6 +107,8 @@ fi
+- PROJECT_ROOT="$($GIT_CMD rev-parse --show-toplevel)"
+- cd "$PROJECT_ROOT" || exit 1
+- 
+-+echo "🔍 Claude Code 正在审核本次提交..."
+-+
+- # 设置临时文件路径
+- TMP_DIR="/tmp"
+- DIFF_FILE="$TMP_DIR/claude_diff_$$.patch"
+-@@ -151,4 +122,750 @@ if [ ! -s "$DIFF_FILE" ]; then
+-   exit 0
+- fi
+- 
+--# ... [后面所有原有代码保持不变] ...
+-+# 设置审核结果输出文件
+-+REVIEW_FILE="$PROJECT_ROOT/last_review_info.txt"
+-+
+-+# 检测项目类型（iOS 或 Android）
+-+PROJECT_TYPE=""
+-+
+-+# 检测 iOS 项目特征
+-+IOS_INDICATORS=0
+-+if [ -f "$PROJECT_ROOT/Podfile" ]; then
+-+  IOS_INDICATORS=$((IOS_INDICATORS + 1))
+-+fi
+-+if find "$PROJECT_ROOT" -maxdepth 1 -name "*.xcodeproj" -o -name "*.xcworkspace" 2>/dev/null | grep -q .; then
+-+  IOS_INDICATORS=$((IOS_INDICATORS + 1))
+-+fi
+-+if find "$PROJECT_ROOT" -maxdepth 2 -name "Info.plist" 2>/dev/null | grep -q .; then
+-+  IOS_INDICATORS=$((IOS_INDICATORS + 1))
+-+fi
+-+
+-+# 检测 Android 项目特征
+-+ANDROID_INDICATORS=0
+-+if [ -f "$PROJECT_ROOT/build.gradle" ] || [ -f "$PROJECT_ROOT/settings.gradle" ]; then
+-+  ANDROID_INDICATORS=$((ANDROID_INDICATORS + 1))
+-+fi
+-+if [ -f "$PROJECT_ROOT/app/build.gradle" ] || [ -d "$PROJECT_ROOT/app" ]; then
+-+  ANDROID_INDICATORS=$((ANDROID_INDICATORS + 1))
+-+fi
+-+if find "$PROJECT_ROOT" -maxdepth 2 -name "AndroidManifest.xml" 2>/dev/null | grep -q .; then
+-+  ANDROID_INDICATORS=$((ANDROID_INDICATORS + 1))
+-+fi
+-+
+-+# 根据指标数量判断项目类型
+-+if [ $IOS_INDICATORS -gt $ANDROID_INDICATORS ]; then
+-+  PROJECT_TYPE="ios"
+-+  echo "📱 检测到 iOS 项目"
+-+elif [ $ANDROID_INDICATORS -gt 0 ]; then
+-+  PROJECT_TYPE="android"
+-+  echo "🤖 检测到 Android 项目"
+-+else
+-+  # 默认使用 iOS（如果无法检测）
+-+  PROJECT_TYPE="ios"
+-+  echo "⚠️  无法确定项目类型，默认使用 iOS 审核规则"
+-+fi
+-+
+-+# 根据项目类型设置审核提示词文件
+-+if [ "$PROJECT_TYPE" = "ios" ]; then
+-+  PROMPT_FILE="$PROJECT_ROOT/CodeReview/claude_prompt_ios.txt"
+-+elif [ "$PROJECT_TYPE" = "android" ]; then
+-+  PROMPT_FILE="$PROJECT_ROOT/CodeReview/claude_prompt_android.txt"
+-+else
+-+  PROMPT_FILE="$PROJECT_ROOT/CodeReview/claude_prompt.txt"
+-+fi
+-+
+-+# 获取变更的文件列表
+-+CHANGED_FILES=$(grep "^diff --git" "$DIFF_FILE" | sed 's/diff --git a\///' | sed 's/diff --git b\///' | cut -d' ' -f1 | sort | uniq)
+-+
+-+# 检查提示词文件是否存在，如果不存在则尝试使用默认文件
+-+if [ ! -f "$PROMPT_FILE" ]; then
+-+  echo "⚠️  提示词文件不存在: $PROMPT_FILE"
+-+  
+-+  # 尝试使用默认文件
+-+  DEFAULT_PROMPT_FILE="$PROJECT_ROOT/CodeReview/claude_prompt.txt"
+-+  if [ -f "$DEFAULT_PROMPT_FILE" ]; then
+-+    echo "ℹ️  使用默认提示词文件: $DEFAULT_PROMPT_FILE"
+-+    PROMPT_FILE="$DEFAULT_PROMPT_FILE"
+-+  else
+-+    echo "❌ 错误: 提示词文件不存在，且默认文件也不存在"
+-+    echo "   请创建以下文件之一："
+-+    echo "   - $PROJECT_ROOT/CodeReview/claude_prompt_ios.txt (iOS 项目)"
+-+    echo "   - $PROJECT_ROOT/CodeReview/claude_prompt_android.txt (Android 项目)"
+-+    echo "   - $PROJECT_ROOT/CodeReview/claude_prompt.txt (通用)"
+-+    exit 1
+-+  fi
+-+fi
+-+
+-+# 检查 claude 命令是否可用（尝试多个可能的路径）
+-+CLAUDE_CMD=""
+-+CLAUDE_AVAILABLE=false
+-+
+-+# 尝试多个可能的 claude 命令路径
+-+if command -v claude &> /dev/null; then
+-+  CLAUDE_CMD="claude"
+-+  CLAUDE_AVAILABLE=true
+-+elif [ -f "$HOME/.local/bin/claude" ]; then
+-+  CLAUDE_CMD="$HOME/.local/bin/claude"
+-+  CLAUDE_AVAILABLE=true
+-+elif [ -f "/usr/local/bin/claude" ]; then
+-+  CLAUDE_CMD="/usr/local/bin/claude"
+-+  CLAUDE_AVAILABLE=true
+-+elif [ -f "/opt/homebrew/bin/claude" ]; then
+-+  CLAUDE_CMD="/opt/homebrew/bin/claude"
+-+  CLAUDE_AVAILABLE=true
+-+elif [ -f "$HOME/bin/claude" ]; then
+-+  CLAUDE_CMD="$HOME/bin/claude"
+-+  CLAUDE_AVAILABLE=true
+-+fi
+-+
+-+# 如果找到了 claude 命令，验证它是否可执行
+-+if [ "$CLAUDE_AVAILABLE" = true ] && [ -n "$CLAUDE_CMD" ]; then
+-+  if [ ! -x "$CLAUDE_CMD" ] && ! command -v "$CLAUDE_CMD" &> /dev/null; then
+-+    CLAUDE_AVAILABLE=false
+-+    CLAUDE_CMD=""
+-+  fi
+-+fi
+-+
+-+# 调用 claude（带超时处理，默认 60 秒）
+-+CLAUDE_TIMEOUT=60
+-+CLAUDE_ERROR=false
+-+RAW_RESULT=""
+-+
+-+if [ "$CLAUDE_AVAILABLE" = true ] && [ -n "$CLAUDE_CMD" ]; then
+-+  echo "⏳ 正在调用 Claude 进行代码审核（最多等待 ${CLAUDE_TIMEOUT} 秒）..."
+-+  echo "   使用命令: $CLAUDE_CMD"
+-+  
+-+  # 创建临时文件存储结果
+-+  TEMP_RESULT=$(mktemp 2>/dev/null || echo "$TMP_DIR/claude_result_$$.txt")
+-+  TEMP_PID=$(mktemp 2>/dev/null || echo "$TMP_DIR/claude_pid_$$.txt")
+-+  touch "$TEMP_RESULT" "$TEMP_PID"
+-+  
+-+  # 在后台运行 claude（使用完整路径，并确保环境变量正确）
+-+  (
+-+    # 确保 PATH 包含常用路径
+-+    export PATH="$HOME/.local/bin:/usr/local/bin:/opt/homebrew/bin:$HOME/bin:$PATH"
+-+    "$CLAUDE_CMD" <<EOF 2>&1
+-+$(cat "$PROMPT_FILE")
+-+git diff 内容如下：
+-+$(cat "$DIFF_FILE")
+-+EOF
+-+    echo $? > "$TEMP_PID"
+-+  ) > "$TEMP_RESULT" 2>&1 &
+-+  
+-+  CLAUDE_PID=$!
+-+  
+-+  # 验证后台进程是否成功启动
+-+  sleep 0.5
+-+  if ! kill -0 $CLAUDE_PID 2>/dev/null; then
+-+    # 进程立即退出了，可能是启动失败
+-+    CLAUDE_ERROR=true
+-+    echo "⚠️  Claude 进程启动失败，检查错误信息："
+-+    if [ -f "$TEMP_RESULT" ]; then
+-+      cat "$TEMP_RESULT" | head -20
+-+      RAW_RESULT=$(cat "$TEMP_RESULT" 2>/dev/null)
+-+    fi
+-+    rm -f "$TEMP_RESULT" "$TEMP_PID"
+-+  else
+-+    # 进程成功启动，等待进程完成或超时
+-+    WAIT_COUNT=0
+-+    while [ $WAIT_COUNT -lt $CLAUDE_TIMEOUT ]; do
+-+      if ! kill -0 $CLAUDE_PID 2>/dev/null; then
+-+        # 进程已结束
+-+        break
+-+      fi
+-+      sleep 1
+-+      WAIT_COUNT=$((WAIT_COUNT + 1))
+-+    done
+-+    
+-+    # 检查是否超时
+-+    if kill -0 $CLAUDE_PID 2>/dev/null; then
+-+      # 进程仍在运行，超时了
+-+      kill $CLAUDE_PID 2>/dev/null
+-+      kill -9 $CLAUDE_PID 2>/dev/null
+-+      CLAUDE_ERROR=true
+-+      echo "⏱️  Claude 审核超时（${CLAUDE_TIMEOUT} 秒）"
+-+      RAW_RESULT=""
+-+      rm -f "$TEMP_RESULT" "$TEMP_PID"
+-+    else
+-+      # 读取结果
+-+      RAW_RESULT=$(cat "$TEMP_RESULT" 2>/dev/null)
+-+      EXIT_CODE=$(cat "$TEMP_PID" 2>/dev/null || echo "0")
+-+      
+-+      # 清理临时文件
+-+      rm -f "$TEMP_RESULT" "$TEMP_PID"
+-+      
+-+      # 检查返回码
+-+      if [ "$EXIT_CODE" != "0" ]; then
+-+        CLAUDE_ERROR=true
+-+        echo "❌ Claude 调用失败（退出码: $EXIT_CODE）"
+-+        if [ -n "$RAW_RESULT" ]; then
+-+          echo "   错误信息: $(echo "$RAW_RESULT" | head -5 | tr '\n' ' ')"
+-+        fi
+-+      fi
+-+      
+-+      # 检查结果是否为空或包含错误信息
+-+      if [ -z "$RAW_RESULT" ]; then
+-+        CLAUDE_ERROR=true
+-+        echo "⚠️  Claude 返回了空结果"
+-+      elif echo "$RAW_RESULT" | grep -qE "(error|Error|ERROR|EPERM|operation not permitted|timeout|Timeout)" 2>/dev/null; then
+-+        # 检查是否是真正的错误（排除正常的审核结果中可能包含这些词）
+-+        if echo "$RAW_RESULT" | grep -qE "^\s*\{\"type\":\"result\".*\"is_error\":true" 2>/dev/null; then
+-+          CLAUDE_ERROR=true
+-+          echo "⚠️  Claude 返回了错误"
+-+        fi
+-+      fi
+-+    fi
+-+  fi
+-+else
+-+  CLAUDE_ERROR=true
+-+  echo "❌ Claude 命令不可用"
+-+  echo "   尝试的路径："
+-+  echo "   - claude (PATH)"
+-+  echo "   - $HOME/.local/bin/claude"
+-+  echo "   - /usr/local/bin/claude"
+-+  echo "   - /opt/homebrew/bin/claude"
+-+  echo "   - $HOME/bin/claude"
+-+  echo ""
+-+  echo "   当前 PATH: $PATH"
+-+fi
+-+
+-+# macOS 弹窗函数 - 修复版本
+-+show_macos_dialog() {
+-+  local message="$1"
+-+  local title="$2"
+-+  local buttons="$3"
+-+  local default_button="$4"
+-+
+-+  # 修复：在AppleScript中直接构建消息，避免shell变量替换问题
+-+  osascript <<EOF 2>/dev/null
+-+    set theMessage to "$message"
+-+    set theButtons to {$buttons}
+-+    set theResult to display dialog theMessage buttons theButtons default button "$default_button" with title "$title" with icon caution
+-+    return button returned of theResult
+-+EOF
+-+  return $?
+-+}
+-+
+-+# 如果 claude 不可用或出错，询问用户是否继续
+-+if [ "$CLAUDE_ERROR" = true ] || [ "$CLAUDE_AVAILABLE" = false ]; then
+-+  echo ""
+-+  echo "⚠️  Claude 审核服务不可用或出错"
+-+  echo ""
+-+  
+-+  # 使用弹窗询问用户
+-+  USER_CHOICE=""
+-+  if [ "$IS_MAC" = true ] && [ "$HAS_GUI_SESSION" = true ]; then
+-+    # 修复：使用单行消息避免格式问题
+-+    USER_CHOICE=$(show_macos_dialog \
+-+    "Claude代码审核服务不可用或超时\n原因可能是：\n- Claude服务暂时不可用\n- 网络连接问题\n- 审核超时（超过${CLAUDE_TIMEOUT}秒）\n是否继续提交代码？" \
+-+    "代码审核服务异常" \
+-+    "\"取消提交\", \"继续提交\"" \
+-+    "继续提交")
+-+    DIALOG_EXIT_CODE=$?
+-+
+-+    # 如果弹窗失败，降级到命令行交互
+-+    if [ $DIALOG_EXIT_CODE -ne 0 ]; then
+-+      echo "⚠️  无法显示弹窗（可能处于无 GUI 环境），使用命令行交互"
+-+      USER_CHOICE=""
+-+    else
+-+      # 清理返回值（去除可能的空白字符）
+-+      USER_CHOICE=$(echo "$USER_CHOICE" | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
+-+    fi
+-+
+-+    case "$USER_CHOICE" in
+-+      "取消提交")
+-+        echo "❌ 用户选择取消提交"
+-+        exit 1
+-+        ;;
+-+      "继续提交")
+-+        echo "✅ 用户选择继续提交（跳过审核）"
+-+        echo ""
+-+        # 清理临时文件
+-+        rm -f "$DIFF_FILE" "$TEMP_RESULT" "$TEMP_PID" 2>/dev/null
+-+        exit 0
+-+        ;;
+-+      *)
+-+        # 弹窗失败或返回空值，使用命令行交互
+-+        echo "================================================================="
+-+        echo "Claude 代码审核服务不可用或超时"
+-+        echo "================================================================="
+-+        echo ""
+-+        echo "原因可能是："
+-+        echo "  - Claude 服务暂时不可用"
+-+        echo "  - 网络连接问题"
+-+        echo "  - 审核超时（超过 ${CLAUDE_TIMEOUT} 秒）"
+-+        echo ""
+-+        echo "是否继续提交代码？"
+-+        echo ""
+-+        echo "输入命令："
+-+        echo "  1) yes  - 继续提交（跳过审核）"
+-+        echo "  2) no   - 取消提交"
+-+        echo ""
+-+
+-+        while true; do
+-+          printf "你的选择 (yes/no): "
+-+          read choice
+-+          choice=$(echo "$choice" | xargs)
+-+
+-+          if [ -z "$choice" ]; then
+-+            echo ""
+-+            echo "提示： 请输入 yes 或 no， 或按 ctrl+c 取消"
+-+            echo ""
+-+            continue
+-+          fi
+-+
+-+          case "$choice" in
+-+            yes|y|Y|YES)
+-+              echo ""
+-+              echo "✅ 继续提交（跳过审核）"
+-+              echo ""
+-+              # 清理临时文件
+-+              rm -f "$DIFF_FILE" "$TEMP_RESULT" "$TEMP_PID" 2>/dev/null
+-+              exit 0
+-+              ;;
+-+            no|n|N|NO)
+-+              echo ""
+-+              echo "❌ 取消提交"
+-+              exit 1
+-+              ;;
+-+            *)
+-+              echo ""
+-+              echo "提示： 请输入 yes 或 no， 或按 ctrl+c 取消"
+-+              echo ""
+-+              ;;
+-+          esac
+-+        done
+-+        ;;
+-+    esac
+-+  else
+-+    # 非 macOS 系统，使用命令行交互
+-+    echo "================================================================="
+-+    echo "Claude 代码审核服务不可用或超时"
+-+    echo "================================================================="
+-+    echo ""
+-+    echo "原因可能是："
+-+    echo "  - Claude 服务暂时不可用"
+-+    echo "  - 网络连接问题"
+-+    echo "  - 审核超时（超过 ${CLAUDE_TIMEOUT} 秒）"
+-+    echo ""
+-+    echo "是否继续提交代码？"
+-+    echo ""
+-+    echo "输入命令："
+-+    echo "  1) yes  - 继续提交（跳过审核）"
+-+    echo "  2) no   - 取消提交"
+-+    echo ""
+-+    
+-+    while true; do
+-+      printf "你的选择 (yes/no): "
+-+      read choice
+-+      choice=$(echo "$choice" | xargs)
+-+
+-+      if [ -z "$choice" ]; then
+-+        echo ""
+-+        echo "提示： 请输入 yes 或 no， 或按 ctrl+c 取消"
+-+        echo ""
+-+        continue
+-+      fi
+-+
+-+      case "$choice" in
+-+        yes|y|Y|YES)
+-+          echo ""
+-+          echo "✅ 继续提交（跳过审核）"
+-+          echo ""
+-+          # 清理临时文件
+-+          rm -f "$DIFF_FILE" "$TEMP_RESULT" "$TEMP_PID" 2>/dev/null
+-+          exit 0
+-+          ;;
+-+        no|n|N|NO)
+-+          echo ""
+-+          echo "❌ 取消提交"
+-+          exit 1
+-+          ;;
+-+        *)
+-+          echo ""
+-+          echo "提示： 请输入 yes 或 no， 或按 ctrl+c 取消"
+-+          echo ""
+-+          ;;
+-+      esac
+-+    done
+-+  fi
+-+fi
++diff --git a/last_review_info.txt b/last_review_info.txt
++new file mode 100644
++index 0000000..23c0d9d
++--- /dev/null
+++++ b/last_review_info.txt
++@@ -0,0 +1,978 @@
+++=====================================================================
+++                         代码审核报告
+++=====================================================================
+ +
+-+# 过滤掉 diff 命令的错误信息和 JSON，但保留有用的内容
+-+CLEAN_RESULT=$(echo "$RAW_RESULT" || true) || true
+++审核时间: 2026-01-28 12:45:20
+ +
+-+# 将审核结果写入 last_review_info.txt
+-+echo "=====================================================================" > "$REVIEW_FILE"
+-+echo "                         代码审核报告" >> "$REVIEW_FILE"
+-+echo "=====================================================================" >> "$REVIEW_FILE"
+-+echo "" >> "$REVIEW_FILE"
+-+echo "审核时间: $(date '+%Y-%m-%d %H:%M:%S')" >> "$REVIEW_FILE"
+-+echo "" >> "$REVIEW_FILE"
+-+echo "==========" >> "$REVIEW_FILE"
+-+echo "" >> "$REVIEW_FILE"
+++==========
+ +
+-+# 检查是否有审核结果
+-+if [ -n "$CLEAN_RESULT" ]; then
+-+  echo "$CLEAN_RESULT" >> "$REVIEW_FILE"
+-+else
+-+  echo "注意：Claude 审核服务暂时不可用，以下是本次提交的变更信息：" >> "$REVIEW_FILE"
+-+  echo "" >> "$REVIEW_FILE"
+-+  echo "## 变更文件" >> "$REVIEW_FILE"
+-+  echo "" >> "$REVIEW_FILE"
+-+  echo "$CHANGED_FILES" | while read file; do
+-+    echo "- $file" >> "$REVIEW_FILE"
+-+  done
+-+  echo "" >> "$REVIEW_FILE"
+-+  echo "## 潜在风险分析" >> "$REVIEW_FILE"
+-+  echo "" >> "$REVIEW_FILE"
+-+  echo "由于审核服务暂时不可用，请人工检查以下风险点：" >> "$REVIEW_FILE"
+-+  echo "- 数组越界访问" >> "$REVIEW_FILE"
+-+  echo "- 强制解包 nil 值" >> "$REVIEW_FILE"
+-+  echo "- 内存泄漏" >> "$REVIEW_FILE"
+-+  echo "- 主线程耗时操作" >> "$REVIEW_FILE"
+-+fi
+++# 代码审查报告
+ +
+-+# 在报告末尾添加完整的 git diff（供查看详情时使用）
+-+echo "" >> "$REVIEW_FILE"
+-+echo "=================================================================" >> "$REVIEW_FILE"
+-+echo "                        完整代码变更" >> "$REVIEW_FILE"
+-+echo "=================================================================" >> "$REVIEW_FILE"
+-+echo "" >> "$REVIEW_FILE"
+-+cat "$DIFF_FILE" >> "$REVIEW_FILE"
+++## 一、变更文件列表
+++- CodeReview/claude_precommit.sh
+ +
+-+echo "" >> "$REVIEW_FILE"
+-+echo "=================================================================" >> "$REVIEW_FILE"
+++---
+ +
+-+echo "✅ 审核完成，已生成报告文件: last_review_info.txt"
+-+echo ""
+++## 二、潜在风险分析
+ +
+-+# 修复：更智能的风险统计方法
+-+# 首先提取所有风险描述块
+-+RISK_BLOCKS=$(echo "$CLEAN_RESULT" | grep -n "风险描述" | cut -d: -f1)
+++本次变更为一个 **Shell 脚本**，并非 iOS / Swift / Objective-C 代码。根据审查要求，我仅基于 iOS / Swift / SwiftUI / Objective-C 项目相关的风险点进行分析。
+ +
+-+# 初始化计数器
+-+RISK_COUNT=0
+-+HIGH_RISK_COUNT=0
+-+MEDIUM_RISK_COUNT=0
+-+LOW_RISK_COUNT=0
+++**未发现明显的 iOS 项目特定风险**，原因如下：
+ +
+-+# 如果有风险描述，进行详细统计
+-+if [ -n "$RISK_BLOCKS" ]; then
+-+    # 计算风险总数
+-+    RISK_COUNT=$(echo "$RISK_BLOCKS" | wc -l)
+-+    
+-+    # 统计每种风险类型
+-+    HIGH_RISK_COUNT=$(echo "$CLEAN_RESULT" | grep -A5 "风险描述" | grep -c "严重程度.*高\|高风险")
+-+    MEDIUM_RISK_COUNT=$(echo "$CLEAN_RESULT" | grep -A5 "风险描述" | grep -c "严重程度.*中\|中风险")
+-+    LOW_RISK_COUNT=$(echo "$CLEAN_RESULT" | grep -A5 "风险描述" | grep -c "严重程度.*低\|低风险")
+-+    
+-+    # 如果还有其他风险（未明确分类的），都归为中风险
+-+    UNCERTAIN_RISK_COUNT=$((RISK_COUNT - HIGH_RISK_COUNT - MEDIUM_RISK_COUNT - LOW_RISK_COUNT))
+-+    if [ $UNCERTAIN_RISK_COUNT -gt 0 ]; then
+-+        MEDIUM_RISK_COUNT=$((MEDIUM_RISK_COUNT + UNCERTAIN_RISK_COUNT))
+-+    fi
+-+else
+-+    # 如果没有明确的风险描述，尝试其他统计方法
+-+    RISK_COUNT=$(echo "$CLEAN_RESULT" | grep -c "风险描述\|风险提示\|发现.*风险\|潜在问题")
+-+    
+-+    # 如果没有找到任何风险，设置为0
+-+    if [ -z "$RISK_COUNT" ] || [ "$RISK_COUNT" -eq 0 ]; then
+-+        RISK_COUNT=0
+-+        HIGH_RISK_COUNT=0
+-+        MEDIUM_RISK_COUNT=0
+-+        LOW_RISK_COUNT=0
+-+    else
+-+        # 如果有风险但没有明确分类，假设都是中风险
+-+        MEDIUM_RISK_COUNT=$RISK_COUNT
+-+    fi
+-+fi
+++1. **语言范围不匹配**：变更文件为 Bash 脚本（`.sh`），不属于 Swift / SwiftUI / Objective-C 代码范畴，因此不存在以下 iOS 特定风险：
+++   - 强制解包（`!`）
+++   - 强制类型转换（`as!`）
+++   - 数组/字典越界访问
+++   - UI 线程问题
+++   - SwiftUI 状态异常
+++   - 循环引用（闭包捕获 self）
+++   - ARC 内存泄漏
+++   - GCD / Swift Concurrency 并发问题
+++   - iOS API 兼容性问题
+ +
+-+# 确保所有值都是数字
+-+RISK_COUNT=$((RISK_COUNT))
+-+HIGH_RISK_COUNT=$((HIGH_RISK_COUNT))
+-+MEDIUM_RISK_COUNT=$((MEDIUM_RISK_COUNT))
+-+LOW_RISK_COUNT=$((LOW_RISK_COUNT))
+++2. **架构设计层面**：本脚本为自动化工具代码，不涉及 iOS 项目的 View / ViewModel / Model 架构设计。
+ +
+-+# 修复：文件数统计
+-+FILE_COUNT=$(echo "$CHANGED_FILES" | wc -w)
+-+FILE_COUNT=$((FILE_COUNT))
+++---
+ +
+-+# 调试：显示统计值
+-+echo "调试信息 - 风险统计:"
+-+echo "  总风险数: $RISK_COUNT"
+-+echo "  高风险数: $HIGH_RISK_COUNT"
+-+echo "  中风险数: $MEDIUM_RISK_COUNT"
+-+echo "  低风险数: $LOW_RISK_COUNT"
+-+echo "  变更文件数: $FILE_COUNT"
+++## 三、通用编程风险（非 iOS 专项）
+ +
+-+# 初始化用户选择变量
+-+CHOICE=""
+++虽然不涉及 iOS 特定风险，但从通用编程角度，本脚本存在以下潜在问题（供参考）：
+ +
+-+# 修复：专门的审核结果弹窗函数
+-+if [ "$IS_MAC" = true ] && [ "$HAS_GUI_SESSION" = true ]; then
+-+  # 直接在AppleScript中构建完整消息
+-+  CHOICE=$(osascript <<EOF 2>/dev/null
+-+    set fileCount to "$FILE_COUNT"
+-+    set riskCount to "$RISK_COUNT"
+-+    set highRisk to "$HIGH_RISK_COUNT"
+-+    set mediumRisk to "$MEDIUM_RISK_COUNT"
+-+    set lowRisk to "$LOW_RISK_COUNT"
+-+    
+-+    -- 清理变量值（确保是纯数字）
+-+    set fileCount to (do shell script "echo '" & fileCount & "' | tr -cd '0-9'")
+-+    set riskCount to (do shell script "echo '" & riskCount & "' | tr -cd '0-9'")
+-+    set highRisk to (do shell script "echo '" & highRisk & "' | tr -cd '0-9'")
+-+    set mediumRisk to (do shell script "echo '" & mediumRisk & "' | tr -cd '0-9'")
+-+    set lowRisk to (do shell script "echo '" & lowRisk & "' | tr -cd '0-9'")
+-+    
+-+    -- 如果为空则设为0
+-+    if fileCount is "" then set fileCount to "0"
+-+    if riskCount is "" then set riskCount to "0"
+-+    if highRisk is "" then set highRisk to "0"
+-+    if mediumRisk is "" then set mediumRisk to "0"
+-+    if lowRisk is "" then set lowRisk to "0"
+-+    
+-+    -- 验证风险总数等于各类风险之和
+-+    set totalRisks to (highRisk as integer) + (mediumRisk as integer) + (lowRisk as integer)
+-+    if totalRisks ≠ (riskCount as integer) then
+-+        -- 如果不匹配，调整风险总数
+-+        set riskCount to (totalRisks as string)
+-+    end if
+-+    
+-+    -- 构建消息
+-+    set msgLines to {}
+-+    set end of msgLines to "代码审核完成"
+-+    set end of msgLines to "变更文件数: " & fileCount
+-+    set end of msgLines to "发现风险数: " & riskCount
+-+    
+-+    if (highRisk as integer) > 0 then
+-+        set end of msgLines to "  - 高风险: " & highRisk
+-+    end if
+-+    
+-+    if (mediumRisk as integer) > 0 then
+-+        set end of msgLines to "  - 中风险: " & mediumRisk
+-+    end if
+-+    
+-+    if (lowRisk as integer) > 0 then
+-+        set end of msgLines to "  - 低风险: " & lowRisk
+-+    end if
+-+    
+-+    -- 如果没有找到风险类型，显示一个通用提示
+-+    if (highRisk as integer) = 0 and (mediumRisk as integer) = 0 and (lowRisk as integer) = 0 and (riskCount as integer) > 0 then
+-+        set end of msgLines to "  - 请查看详细报告了解风险分类"
+-+    end if
+-+    
+-+    set end of msgLines to "审核报告已保存到: last_review_info.txt"
+-+    
+-+    -- 合并所有行
+-+    set AppleScript's text item delimiters to return
+-+    set theMessage to msgLines as text
+-+    set AppleScript's text item delimiters to ""
+-+    
+-+    set theResult to display dialog theMessage ¬
+-+        buttons {"查看详情", "取消提交", "继续提交"} ¬
+-+        default button "查看详情" ¬
+-+        with title "代码审核结果" ¬
+-+        with icon caution
+-+    return button returned of theResult
+-+EOF
+-+  )
+-+  DIALOG_EXIT_CODE=$?
+++### [低] Shell 脚本潜在问题
+ +
+-+  # 如果 osascript 失败（无 GUI 环境），降级到命令行交互
+-+  if [ $DIALOG_EXIT_CODE -ne 0 ] || [ -z "$CHOICE" ]; then
+-+    echo "⚠️  无法显示弹窗（可能处于无 GUI 环境），使用命令行交互"
+-+    CHOICE=""
+-+  fi
+-+fi
+++| 风险类型 | 描述 | 严重程度 | 涉及位置 |
+++|---------|------|---------|---------|
+++| 临时文件清理不完整 | 代码中多次清理 `$TEMP_RESULT` 和 `$TEMP_PID`，但异常退出路径可能遗留临时文件 | 低 | 多处 rm 命令 |
+++| AppleScript 嵌入复杂 | 使用 `osascript` 嵌入多行 AppleScript，存在转义和变量传递的潜在风险 | 低 | 第 6-15 行、第 411-451 行 |
+++| 超时处理可能残留进程 | 超时后使用 `kill -9` 强制终止，可能在极少数场景下留下僵尸进程 | 低 | 第 197-198 行 |
+ +
+-+# 如果弹窗成功，处理用户选择
+-+if [ -n "$CHOICE" ]; then
+-+    case "$CHOICE" in
+-+      "继续提交"|*"继续提交"*)
+-+        echo ""
+-+        echo "✅ 已批准提交"
+-+        echo ""
+-+        exit 0
+-+        ;;
+-+      "取消提交"|*"取消提交"*)
+-+        echo ""
+-+        echo "❌ 已阻断提交"
+-+        echo ""
+-+        echo "请修复问题后重新提交"
+-+        exit 1
+-+        ;;
+-+      "查看详情")
+-+        # 打开审核报告文件（macOS）
+-+        if [ "$IS_MAC" = true ]; then
+-+          open "$REVIEW_FILE"
+-+        else
+-+          # Linux 使用 xdg-open
+-+          xdg-open "$REVIEW_FILE" 2>/dev/null || echo "请手动打开文件: $REVIEW_FILE"
+-+        fi
+-+        echo ""
+-+        echo "已打开审核报告，请查看后决定是否提交"
+-+        
+-+        # 等待一小段时间，确保文件已打开
+-+        sleep 1
+-+        
+-+        # 重新显示弹窗，让用户选择是否提交
+-+        if [ "$IS_MAC" = true ] && [ "$HAS_GUI_SESSION" = true ]; then
+-+          FINAL_CHOICE=$(show_macos_dialog \
+-+          "审核报告已打开\n请查看 last_review_info.txt 文件后，决定是否继续提交代码" \
+-+          "代码审核 - 确认提交" \
+-+          "\"取消提交\", \"继续提交\"" \
+-+          "继续提交")
+-+        else
+-+          FINAL_CHOICE=""
+-+        fi
+-+        
+-+        # 处理最终选择
+-+        case "$FINAL_CHOICE" in
+-+          "继续提交"|*"继续提交"*)
+-+            echo ""
+-+            echo "✅ 已批准提交"
+-+            echo ""
+-+            exit 0
+-+            ;;
+-+          "取消提交"|*"取消提交"*)
+-+            echo ""
+-+            echo "❌ 已阻断提交"
+-+            echo ""
+-+            echo "请修复问题后重新提交"
+-+            exit 1
+-+            ;;
+-+          *)
+-+            # 如果弹窗失败，降级到命令行交互
+-+            echo ""
+-+            echo "⚠️  弹窗显示失败，使用命令行交互"
+-+            echo ""
+-+            echo "================================================================="
+-+            echo "请查看审核报告 last_review_info.txt，然后决定是否继续提交："
+-+            echo "================================================================="
+-+            echo ""
+-+            echo "输入命令："
+-+            echo "  1) yes  - 继续提交（审核报告将保留）"
+-+            echo "  2) no   - 阻断提交（审核报告将保留）"
+-+            echo ""
+++**注意**：以上为 Shell 脚本通用风险，不属于 iOS 项目审查范畴。
+ +
+-+            # 询问用户决定
+-+            while true; do
+-+              printf "你的选择 (yes/no): "
+-+      read choice
+-+              # 去除首尾空格
+-+              choice=$(echo "$choice" | xargs)
+-+              
+-+              # 如果输入为空，跳过本次循环
+-+              if [ -z "$choice" ]; then
+-+                echo ""
+-+                echo "提示： 请输入 yes 或 no， 或按 ctrl+c 取消"
+-+                echo ""
+-+                continue
+-+              fi
+-+              
+-+              case "$choice" in
+-+                yes|y|Y|YES)
+-+                  echo ""
+-+                  echo "✅ 已批准提交"
+-+                  echo ""
+-+                  exit 0
+-+                  ;;
+-+                no|n|N|NO)
+-+                  echo ""
+-+                  echo "❌ 已阻断提交"
+-+                  echo ""
+-+                  echo "请修复问题后重新提交"
+-+                  exit 1
+-+                  ;;
+-+                *)
+-+                  echo "提示： 请输入 yes 或 no， 或按 ctrl+c 取消"
+-+                  echo ""
+-+                  ;;
+-+              esac
+-+            done
+-+            ;;
+-+        esac
+-+        ;;
+-+      *)
+-+        echo ""
+-+        echo "❌ 已取消操作"
+-+        exit 1
+-+        ;;
+-+    esac
+-+fi
+++---
+ +
+-+# 如果弹窗失败或未选择，使用命令行交互
+-+if [ -z "$CHOICE" ]; then
+-+  # 检查标准输入是否可用（是否是交互式终端）
+-+  if [ ! -t 0 ]; then
+-+    echo ""
+-+    echo "⚠️  标准输入不可用，无法使用命令行交互"
+-+    echo ""
+-+    echo "请手动检查审核报告: $REVIEW_FILE"
+-+    echo ""
+-+    
+-+    # 如果设置了允许非交互式提交的环境变量，则允许提交
+-+    if [ "$ALLOW_NONINTERACTIVE_COMMIT" = "1" ]; then
+-+      echo "✅ 检测到 ALLOW_NONINTERACTIVE_COMMIT=1，允许非交互式提交"
+-+      exit 0
+-+    else
+-+      echo "如需继续提交，请使用以下命令之一："
+-+      echo "  1) ALLOW_NONINTERACTIVE_COMMIT=1 git commit -m \"your message\""
+-+      echo "  2) git -c core.hooksPath=/dev/null commit -m \"your message\"  (临时禁用 hook)"
+-+      echo ""
+-+      echo "❌ 阻断提交（标准输入不可用）"
+-+      exit 1
+-+    fi
+-+  fi
+++## 四、结论
+ +
+-+  echo ""
+-+  echo "================================================================="
+-+  echo "请查看审核报告 last_review_info.txt，然后决定是否继续提交："
+-+  echo "================================================================="
+-+  echo ""
+-+  echo "输入命令："
+-+  echo "  1) yes  - 继续提交（审核报告将保留）"
+-+  echo "  2) no   - 阻断提交（审核报告将保留）"
+-+  echo ""
+++**未发现 iOS / Swift / SwiftUI / Objective-C 项目相关的明显风险。**
+ +
+-+  # 询问用户决定
+-+  while true; do
+-+    printf "你的选择 (yes/no): "
+-+    read choice
+-+    # 去除首尾空格
+-+    choice=$(echo "$choice" | xargs)
+++本次变更仅为 Git pre-commit hook 工具脚本的调整，不涉及任何 iOS 应用层代码，因此不存在应用层面的 Crash、内存泄漏、性能问题、线程安全等 iOS 特定风险。
+ +
+-+    # 如果输入为空，跳过本次循环
+-+    if [ -z "$choice" ]; then
+-+      echo ""
+-+      echo "提示： 请输入 yes 或 no， 或按 ctrl+c 取消"
+-+      echo ""
+-+      continue
+-+    fi
+++=================================================================
+++                        完整代码变更
+++=================================================================
+ +
+-+    case "$choice" in
+-+      yes|y|Y|YES)
+-+        echo ""
+-+        echo "✅ 已批准提交"
+-+        echo ""
+-+        exit 0
+-+        ;;
+-+      no|n|N|NO)
+-+        echo ""
+-+        echo "❌ 已阻断提交"
+-+        echo ""
+-+        echo "请修复问题后重新提交"
+-+        exit 1
+-+        ;;
+-+      *)
+-+        echo ""
+-+        echo "提示： 请输入 yes 或 no， 或按 ctrl+c 取消"
+-+        echo ""
+-+        ;;
+-+    esac
+-+  done
+-+fi
+++diff --git a/CodeReview/claude_precommit.sh b/CodeReview/claude_precommit.sh
+++index dbeb03f..390de5a 100755
+++--- a/CodeReview/claude_precommit.sh
++++++ b/CodeReview/claude_precommit.sh
+++@@ -1,56 +1,21 @@
+++ #!/bin/bash
+++ 
+++ # 添加：执行前选择弹窗（放在最前面）
+++-# macOS 弹窗函数
+++-show_macos_dialog() {
+++-  local message="$1"
+++-  local title="$2"
+++-  local buttons="$3"
+++-  local default_button="$4"
+++-
+++-  osascript <<EOF 2>/dev/null
+++-    set theMessage to "$message"
+++-    set theButtons to {$buttons}
+++-    set theResult to display dialog theMessage buttons theButtons default button "$default_button" with title "$title" with icon note
++++# 检测是否是macOS
++++if [[ "$OSTYPE" == "darwin"* ]]; then
++++  # 尝试显示macOS弹窗
++++  CHOICE=$(osascript <<EOF 2>/dev/null
++++    set theResult to display dialog "请选择执行方式：" & return & return & "1. 审核代码 - 分析代码变更并生成审核报告" & return & "2. 直接提交 - 跳过审核直接提交代码" ¬
++++        buttons {"审核代码", "直接提交"} ¬
++++        default button "审核代码" ¬
++++        with title "代码提交 - 执行选择" ¬
++++        with icon note
+++     return button returned of theResult
+++ EOF
+++-  return $?
+++-}
+++-
+++-# 检测操作系统类型（仅 macOS）
+++-IS_MAC=false
+++-if [[ "$OSTYPE" == "darwin"* ]]; then
+++-  IS_MAC=true
+++-fi
+++-
+++-# 检测是否有 GUI 会话（macOS）
+++-HAS_GUI_SESSION=true
+++-if [ "$IS_MAC" = true ]; then
+++-  # 尝试运行 osascript 测试
+++-  if ! osascript -e 'tell application "System Events" to get name of every process' >/dev/null 2>&1; then
+++-    HAS_GUI_SESSION=false
+++-  fi
+++-fi
+++-
+++-# 检测是否在 pre-commit hook 中运行
+++-IS_PRE_COMMIT=false
+++-if [ -n "$GIT_PREFIX" ] || [ -n "$GIT_INDEX_FILE" ]; then
+++-  IS_PRE_COMMIT=true
+++-fi
+++-
+++-# 执行前选择：只在非pre-commit模式下显示，并且有GUI会话
+++-if [ "$IS_PRE_COMMIT" = false ] && [ "$IS_MAC" = true ] && [ "$HAS_GUI_SESSION" = true ]; then
+++-  echo "显示执行前选择弹窗..."
++++  )
+++   
+++-  # 显示执行前选择弹窗
+++-  EXEC_CHOICE=$(show_macos_dialog \
+++-    "请选择执行方式：\n\n1. 审核代码 - 分析代码变更并生成审核报告\n2. 直接提交 - 跳过审核直接提交代码" \
+++-    "代码提交 - 执行选择" \
+++-    "\"审核代码\", \"直接提交\"" \
+++-    "审核代码")
+++-  
+++-  if [ $? -eq 0 ] && [ -n "$EXEC_CHOICE" ]; then
+++-    case "$EXEC_CHOICE" in
++++  if [ $? -eq 0 ] && [ -n "$CHOICE" ]; then
++++    case "$CHOICE" in
+++       "直接提交")
+++         echo "✅ 用户选择直接提交，跳过代码审核"
+++         exit 0
+++@@ -62,8 +27,8 @@ if [ "$IS_PRE_COMMIT" = false ] && [ "$IS_MAC" = true ] && [ "$HAS_GUI_SESSION"
+++   fi
+++ fi
+++ 
+++-# 如果不是macOS或没有GUI，或者是在pre-commit中运行，显示命令行选择
+++-if [ "$IS_PRE_COMMIT" = false ] && { [ "$IS_MAC" = false ] || [ "$HAS_GUI_SESSION" = false ] || [ -z "$EXEC_CHOICE" ]; }; then
++++# 如果弹窗失败或不是macOS，显示命令行选择
++++if [[ "$OSTYPE" != "darwin"* ]] || [ -z "$CHOICE" ]; then
+++   echo "================================================================="
+++   echo "                代码提交 - 执行选择"
+++   echo "================================================================="
+++@@ -74,20 +39,12 @@ if [ "$IS_PRE_COMMIT" = false ] && { [ "$IS_MAC" = false ] || [ "$HAS_GUI_SESSIO
+++   echo "  2) 直接提交 - 跳过审核直接提交代码"
+++   echo ""
+++   
+++-  # 检查标准输入是否可用
+++   if [ -t 0 ]; then
+++     while true; do
+++       printf "你的选择 (1或2): "
+++       read choice
+++       choice=$(echo "$choice" | xargs)
+++ 
+++-      if [ -z "$choice" ]; then
+++-        echo ""
+++-        echo "提示： 请输入 1 或 2，或按 ctrl+c 取消"
+++-        echo ""
+++-        continue
+++-      fi
+++-
+++       case "$choice" in
+++         1|"审核代码")
+++           echo ""
+++@@ -101,26 +58,38 @@ if [ "$IS_PRE_COMMIT" = false ] && { [ "$IS_MAC" = false ] || [ "$HAS_GUI_SESSIO
+++           exit 0
+++           ;;
+++         *)
+++-          echo ""
+++           echo "提示： 请输入 1 或 2"
+++-          echo ""
+++           ;;
+++       esac
+++     done
+++   else
+++-    # 非交互式环境，默认执行审核
+++-    echo "⚠️  非交互式环境，自动执行代码审核"
++++    echo "自动执行代码审核"
+++     echo ""
+++   fi
+++ fi
+++ 
+++-# 如果是pre-commit模式，直接执行审核（不显示选择）
+++-if [ "$IS_PRE_COMMIT" = true ]; then
+++-  echo "pre-commit hook 模式，自动执行代码审核"
++++# 以下是您原来的脚本内容，不做任何修改
++++
++++# 检测是否在 pre-commit hook 中运行
++++IS_PRE_COMMIT=false
++++if [ -n "$GIT_PREFIX" ] || [ -n "$GIT_INDEX_FILE" ]; then
++++  IS_PRE_COMMIT=true
++++fi
++++
++++# 检测操作系统类型（仅 macOS）
++++IS_MAC=false
++++if [[ "$OSTYPE" == "darwin"* ]]; then
++++  IS_MAC=true
+++ fi
+++ 
+++-# 以下是您原来的脚本内容，不做任何修改
+++-echo "🔍 Claude Code 正在审核本次提交..."
++++# 检测是否有 GUI 会话（macOS）
++++HAS_GUI_SESSION=true
++++if [ "$IS_MAC" = true ]; then
++++  # 尝试运行 osascript 测试
++++  if ! osascript -e 'tell application "System Events" to get name of every process' >/dev/null 2>&1; then
++++    HAS_GUI_SESSION=false
++++  fi
++++fi
+++ 
+++ # 检测 git 命令路径
+++ if command -v git &> /dev/null; then
+++@@ -138,6 +107,8 @@ fi
+++ PROJECT_ROOT="$($GIT_CMD rev-parse --show-toplevel)"
+++ cd "$PROJECT_ROOT" || exit 1
+++ 
++++echo "🔍 Claude Code 正在审核本次提交..."
++++
+++ # 设置临时文件路径
+++ TMP_DIR="/tmp"
+++ DIFF_FILE="$TMP_DIR/claude_diff_$$.patch"
+++@@ -151,4 +122,750 @@ if [ ! -s "$DIFF_FILE" ]; then
+++   exit 0
+++ fi
+++ 
+++-# ... [后面所有原有代码保持不变] ...
++++# 设置审核结果输出文件
++++REVIEW_FILE="$PROJECT_ROOT/last_review_info.txt"
++++
++++# 检测项目类型（iOS 或 Android）
++++PROJECT_TYPE=""
++++
++++# 检测 iOS 项目特征
++++IOS_INDICATORS=0
++++if [ -f "$PROJECT_ROOT/Podfile" ]; then
++++  IOS_INDICATORS=$((IOS_INDICATORS + 1))
++++fi
++++if find "$PROJECT_ROOT" -maxdepth 1 -name "*.xcodeproj" -o -name "*.xcworkspace" 2>/dev/null | grep -q .; then
++++  IOS_INDICATORS=$((IOS_INDICATORS + 1))
++++fi
++++if find "$PROJECT_ROOT" -maxdepth 2 -name "Info.plist" 2>/dev/null | grep -q .; then
++++  IOS_INDICATORS=$((IOS_INDICATORS + 1))
++++fi
++++
++++# 检测 Android 项目特征
++++ANDROID_INDICATORS=0
++++if [ -f "$PROJECT_ROOT/build.gradle" ] || [ -f "$PROJECT_ROOT/settings.gradle" ]; then
++++  ANDROID_INDICATORS=$((ANDROID_INDICATORS + 1))
++++fi
++++if [ -f "$PROJECT_ROOT/app/build.gradle" ] || [ -d "$PROJECT_ROOT/app" ]; then
++++  ANDROID_INDICATORS=$((ANDROID_INDICATORS + 1))
++++fi
++++if find "$PROJECT_ROOT" -maxdepth 2 -name "AndroidManifest.xml" 2>/dev/null | grep -q .; then
++++  ANDROID_INDICATORS=$((ANDROID_INDICATORS + 1))
++++fi
++++
++++# 根据指标数量判断项目类型
++++if [ $IOS_INDICATORS -gt $ANDROID_INDICATORS ]; then
++++  PROJECT_TYPE="ios"
++++  echo "📱 检测到 iOS 项目"
++++elif [ $ANDROID_INDICATORS -gt 0 ]; then
++++  PROJECT_TYPE="android"
++++  echo "🤖 检测到 Android 项目"
++++else
++++  # 默认使用 iOS（如果无法检测）
++++  PROJECT_TYPE="ios"
++++  echo "⚠️  无法确定项目类型，默认使用 iOS 审核规则"
++++fi
++++
++++# 根据项目类型设置审核提示词文件
++++if [ "$PROJECT_TYPE" = "ios" ]; then
++++  PROMPT_FILE="$PROJECT_ROOT/CodeReview/claude_prompt_ios.txt"
++++elif [ "$PROJECT_TYPE" = "android" ]; then
++++  PROMPT_FILE="$PROJECT_ROOT/CodeReview/claude_prompt_android.txt"
++++else
++++  PROMPT_FILE="$PROJECT_ROOT/CodeReview/claude_prompt.txt"
++++fi
++++
++++# 获取变更的文件列表
++++CHANGED_FILES=$(grep "^diff --git" "$DIFF_FILE" | sed 's/diff --git a\///' | sed 's/diff --git b\///' | cut -d' ' -f1 | sort | uniq)
++++
++++# 检查提示词文件是否存在，如果不存在则尝试使用默认文件
++++if [ ! -f "$PROMPT_FILE" ]; then
++++  echo "⚠️  提示词文件不存在: $PROMPT_FILE"
++++  
++++  # 尝试使用默认文件
++++  DEFAULT_PROMPT_FILE="$PROJECT_ROOT/CodeReview/claude_prompt.txt"
++++  if [ -f "$DEFAULT_PROMPT_FILE" ]; then
++++    echo "ℹ️  使用默认提示词文件: $DEFAULT_PROMPT_FILE"
++++    PROMPT_FILE="$DEFAULT_PROMPT_FILE"
++++  else
++++    echo "❌ 错误: 提示词文件不存在，且默认文件也不存在"
++++    echo "   请创建以下文件之一："
++++    echo "   - $PROJECT_ROOT/CodeReview/claude_prompt_ios.txt (iOS 项目)"
++++    echo "   - $PROJECT_ROOT/CodeReview/claude_prompt_android.txt (Android 项目)"
++++    echo "   - $PROJECT_ROOT/CodeReview/claude_prompt.txt (通用)"
++++    exit 1
++++  fi
++++fi
++++
++++# 检查 claude 命令是否可用（尝试多个可能的路径）
++++CLAUDE_CMD=""
++++CLAUDE_AVAILABLE=false
++++
++++# 尝试多个可能的 claude 命令路径
++++if command -v claude &> /dev/null; then
++++  CLAUDE_CMD="claude"
++++  CLAUDE_AVAILABLE=true
++++elif [ -f "$HOME/.local/bin/claude" ]; then
++++  CLAUDE_CMD="$HOME/.local/bin/claude"
++++  CLAUDE_AVAILABLE=true
++++elif [ -f "/usr/local/bin/claude" ]; then
++++  CLAUDE_CMD="/usr/local/bin/claude"
++++  CLAUDE_AVAILABLE=true
++++elif [ -f "/opt/homebrew/bin/claude" ]; then
++++  CLAUDE_CMD="/opt/homebrew/bin/claude"
++++  CLAUDE_AVAILABLE=true
++++elif [ -f "$HOME/bin/claude" ]; then
++++  CLAUDE_CMD="$HOME/bin/claude"
++++  CLAUDE_AVAILABLE=true
++++fi
++++
++++# 如果找到了 claude 命令，验证它是否可执行
++++if [ "$CLAUDE_AVAILABLE" = true ] && [ -n "$CLAUDE_CMD" ]; then
++++  if [ ! -x "$CLAUDE_CMD" ] && ! command -v "$CLAUDE_CMD" &> /dev/null; then
++++    CLAUDE_AVAILABLE=false
++++    CLAUDE_CMD=""
++++  fi
++++fi
++++
++++# 调用 claude（带超时处理，默认 60 秒）
++++CLAUDE_TIMEOUT=60
++++CLAUDE_ERROR=false
++++RAW_RESULT=""
++++
++++if [ "$CLAUDE_AVAILABLE" = true ] && [ -n "$CLAUDE_CMD" ]; then
++++  echo "⏳ 正在调用 Claude 进行代码审核（最多等待 ${CLAUDE_TIMEOUT} 秒）..."
++++  echo "   使用命令: $CLAUDE_CMD"
++++  
++++  # 创建临时文件存储结果
++++  TEMP_RESULT=$(mktemp 2>/dev/null || echo "$TMP_DIR/claude_result_$$.txt")
++++  TEMP_PID=$(mktemp 2>/dev/null || echo "$TMP_DIR/claude_pid_$$.txt")
++++  touch "$TEMP_RESULT" "$TEMP_PID"
++++  
++++  # 在后台运行 claude（使用完整路径，并确保环境变量正确）
++++  (
++++    # 确保 PATH 包含常用路径
++++    export PATH="$HOME/.local/bin:/usr/local/bin:/opt/homebrew/bin:$HOME/bin:$PATH"
++++    "$CLAUDE_CMD" <<EOF 2>&1
++++$(cat "$PROMPT_FILE")
++++git diff 内容如下：
++++$(cat "$DIFF_FILE")
++++EOF
++++    echo $? > "$TEMP_PID"
++++  ) > "$TEMP_RESULT" 2>&1 &
++++  
++++  CLAUDE_PID=$!
++++  
++++  # 验证后台进程是否成功启动
++++  sleep 0.5
++++  if ! kill -0 $CLAUDE_PID 2>/dev/null; then
++++    # 进程立即退出了，可能是启动失败
++++    CLAUDE_ERROR=true
++++    echo "⚠️  Claude 进程启动失败，检查错误信息："
++++    if [ -f "$TEMP_RESULT" ]; then
++++      cat "$TEMP_RESULT" | head -20
++++      RAW_RESULT=$(cat "$TEMP_RESULT" 2>/dev/null)
++++    fi
++++    rm -f "$TEMP_RESULT" "$TEMP_PID"
++++  else
++++    # 进程成功启动，等待进程完成或超时
++++    WAIT_COUNT=0
++++    while [ $WAIT_COUNT -lt $CLAUDE_TIMEOUT ]; do
++++      if ! kill -0 $CLAUDE_PID 2>/dev/null; then
++++        # 进程已结束
++++        break
++++      fi
++++      sleep 1
++++      WAIT_COUNT=$((WAIT_COUNT + 1))
++++    done
++++    
++++    # 检查是否超时
++++    if kill -0 $CLAUDE_PID 2>/dev/null; then
++++      # 进程仍在运行，超时了
++++      kill $CLAUDE_PID 2>/dev/null
++++      kill -9 $CLAUDE_PID 2>/dev/null
++++      CLAUDE_ERROR=true
++++      echo "⏱️  Claude 审核超时（${CLAUDE_TIMEOUT} 秒）"
++++      RAW_RESULT=""
++++      rm -f "$TEMP_RESULT" "$TEMP_PID"
++++    else
++++      # 读取结果
++++      RAW_RESULT=$(cat "$TEMP_RESULT" 2>/dev/null)
++++      EXIT_CODE=$(cat "$TEMP_PID" 2>/dev/null || echo "0")
++++      
++++      # 清理临时文件
++++      rm -f "$TEMP_RESULT" "$TEMP_PID"
++++      
++++      # 检查返回码
++++      if [ "$EXIT_CODE" != "0" ]; then
++++        CLAUDE_ERROR=true
++++        echo "❌ Claude 调用失败（退出码: $EXIT_CODE）"
++++        if [ -n "$RAW_RESULT" ]; then
++++          echo "   错误信息: $(echo "$RAW_RESULT" | head -5 | tr '\n' ' ')"
++++        fi
++++      fi
++++      
++++      # 检查结果是否为空或包含错误信息
++++      if [ -z "$RAW_RESULT" ]; then
++++        CLAUDE_ERROR=true
++++        echo "⚠️  Claude 返回了空结果"
++++      elif echo "$RAW_RESULT" | grep -qE "(error|Error|ERROR|EPERM|operation not permitted|timeout|Timeout)" 2>/dev/null; then
++++        # 检查是否是真正的错误（排除正常的审核结果中可能包含这些词）
++++        if echo "$RAW_RESULT" | grep -qE "^\s*\{\"type\":\"result\".*\"is_error\":true" 2>/dev/null; then
++++          CLAUDE_ERROR=true
++++          echo "⚠️  Claude 返回了错误"
++++        fi
++++      fi
++++    fi
++++  fi
++++else
++++  CLAUDE_ERROR=true
++++  echo "❌ Claude 命令不可用"
++++  echo "   尝试的路径："
++++  echo "   - claude (PATH)"
++++  echo "   - $HOME/.local/bin/claude"
++++  echo "   - /usr/local/bin/claude"
++++  echo "   - /opt/homebrew/bin/claude"
++++  echo "   - $HOME/bin/claude"
++++  echo ""
++++  echo "   当前 PATH: $PATH"
++++fi
++++
++++# macOS 弹窗函数 - 修复版本
++++show_macos_dialog() {
++++  local message="$1"
++++  local title="$2"
++++  local buttons="$3"
++++  local default_button="$4"
++++
++++  # 修复：在AppleScript中直接构建消息，避免shell变量替换问题
++++  osascript <<EOF 2>/dev/null
++++    set theMessage to "$message"
++++    set theButtons to {$buttons}
++++    set theResult to display dialog theMessage buttons theButtons default button "$default_button" with title "$title" with icon caution
++++    return button returned of theResult
++++EOF
++++  return $?
++++}
++++
++++# 如果 claude 不可用或出错，询问用户是否继续
++++if [ "$CLAUDE_ERROR" = true ] || [ "$CLAUDE_AVAILABLE" = false ]; then
++++  echo ""
++++  echo "⚠️  Claude 审核服务不可用或出错"
++++  echo ""
++++  
++++  # 使用弹窗询问用户
++++  USER_CHOICE=""
++++  if [ "$IS_MAC" = true ] && [ "$HAS_GUI_SESSION" = true ]; then
++++    # 修复：使用单行消息避免格式问题
++++    USER_CHOICE=$(show_macos_dialog \
++++    "Claude代码审核服务不可用或超时\n原因可能是：\n- Claude服务暂时不可用\n- 网络连接问题\n- 审核超时（超过${CLAUDE_TIMEOUT}秒）\n是否继续提交代码？" \
++++    "代码审核服务异常" \
++++    "\"取消提交\", \"继续提交\"" \
++++    "继续提交")
++++    DIALOG_EXIT_CODE=$?
++++
++++    # 如果弹窗失败，降级到命令行交互
++++    if [ $DIALOG_EXIT_CODE -ne 0 ]; then
++++      echo "⚠️  无法显示弹窗（可能处于无 GUI 环境），使用命令行交互"
++++      USER_CHOICE=""
++++    else
++++      # 清理返回值（去除可能的空白字符）
++++      USER_CHOICE=$(echo "$USER_CHOICE" | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
++++    fi
++++
++++    case "$USER_CHOICE" in
++++      "取消提交")
++++        echo "❌ 用户选择取消提交"
++++        exit 1
++++        ;;
++++      "继续提交")
++++        echo "✅ 用户选择继续提交（跳过审核）"
++++        echo ""
++++        # 清理临时文件
++++        rm -f "$DIFF_FILE" "$TEMP_RESULT" "$TEMP_PID" 2>/dev/null
++++        exit 0
++++        ;;
++++      *)
++++        # 弹窗失败或返回空值，使用命令行交互
++++        echo "================================================================="
++++        echo "Claude 代码审核服务不可用或超时"
++++        echo "================================================================="
++++        echo ""
++++        echo "原因可能是："
++++        echo "  - Claude 服务暂时不可用"
++++        echo "  - 网络连接问题"
++++        echo "  - 审核超时（超过 ${CLAUDE_TIMEOUT} 秒）"
++++        echo ""
++++        echo "是否继续提交代码？"
++++        echo ""
++++        echo "输入命令："
++++        echo "  1) yes  - 继续提交（跳过审核）"
++++        echo "  2) no   - 取消提交"
++++        echo ""
++++
++++        while true; do
++++          printf "你的选择 (yes/no): "
++++          read choice
++++          choice=$(echo "$choice" | xargs)
++++
++++          if [ -z "$choice" ]; then
++++            echo ""
++++            echo "提示： 请输入 yes 或 no， 或按 ctrl+c 取消"
++++            echo ""
++++            continue
++++          fi
++++
++++          case "$choice" in
++++            yes|y|Y|YES)
++++              echo ""
++++              echo "✅ 继续提交（跳过审核）"
++++              echo ""
++++              # 清理临时文件
++++              rm -f "$DIFF_FILE" "$TEMP_RESULT" "$TEMP_PID" 2>/dev/null
++++              exit 0
++++              ;;
++++            no|n|N|NO)
++++              echo ""
++++              echo "❌ 取消提交"
++++              exit 1
++++              ;;
++++            *)
++++              echo ""
++++              echo "提示： 请输入 yes 或 no， 或按 ctrl+c 取消"
++++              echo ""
++++              ;;
++++          esac
++++        done
++++        ;;
++++    esac
++++  else
++++    # 非 macOS 系统，使用命令行交互
++++    echo "================================================================="
++++    echo "Claude 代码审核服务不可用或超时"
++++    echo "================================================================="
++++    echo ""
++++    echo "原因可能是："
++++    echo "  - Claude 服务暂时不可用"
++++    echo "  - 网络连接问题"
++++    echo "  - 审核超时（超过 ${CLAUDE_TIMEOUT} 秒）"
++++    echo ""
++++    echo "是否继续提交代码？"
++++    echo ""
++++    echo "输入命令："
++++    echo "  1) yes  - 继续提交（跳过审核）"
++++    echo "  2) no   - 取消提交"
++++    echo ""
++++    
++++    while true; do
++++      printf "你的选择 (yes/no): "
++++      read choice
++++      choice=$(echo "$choice" | xargs)
++++
++++      if [ -z "$choice" ]; then
++++        echo ""
++++        echo "提示： 请输入 yes 或 no， 或按 ctrl+c 取消"
++++        echo ""
++++        continue
++++      fi
++++
++++      case "$choice" in
++++        yes|y|Y|YES)
++++          echo ""
++++          echo "✅ 继续提交（跳过审核）"
++++          echo ""
++++          # 清理临时文件
++++          rm -f "$DIFF_FILE" "$TEMP_RESULT" "$TEMP_PID" 2>/dev/null
++++          exit 0
++++          ;;
++++        no|n|N|NO)
++++          echo ""
++++          echo "❌ 取消提交"
++++          exit 1
++++          ;;
++++        *)
++++          echo ""
++++          echo "提示： 请输入 yes 或 no， 或按 ctrl+c 取消"
++++          echo ""
++++          ;;
++++      esac
++++    done
++++  fi
++++fi
++++
++++# 过滤掉 diff 命令的错误信息和 JSON，但保留有用的内容
++++CLEAN_RESULT=$(echo "$RAW_RESULT" || true) || true
++++
++++# 将审核结果写入 last_review_info.txt
++++echo "=====================================================================" > "$REVIEW_FILE"
++++echo "                         代码审核报告" >> "$REVIEW_FILE"
++++echo "=====================================================================" >> "$REVIEW_FILE"
++++echo "" >> "$REVIEW_FILE"
++++echo "审核时间: $(date '+%Y-%m-%d %H:%M:%S')" >> "$REVIEW_FILE"
++++echo "" >> "$REVIEW_FILE"
++++echo "==========" >> "$REVIEW_FILE"
++++echo "" >> "$REVIEW_FILE"
++++
++++# 检查是否有审核结果
++++if [ -n "$CLEAN_RESULT" ]; then
++++  echo "$CLEAN_RESULT" >> "$REVIEW_FILE"
++++else
++++  echo "注意：Claude 审核服务暂时不可用，以下是本次提交的变更信息：" >> "$REVIEW_FILE"
++++  echo "" >> "$REVIEW_FILE"
++++  echo "## 变更文件" >> "$REVIEW_FILE"
++++  echo "" >> "$REVIEW_FILE"
++++  echo "$CHANGED_FILES" | while read file; do
++++    echo "- $file" >> "$REVIEW_FILE"
++++  done
++++  echo "" >> "$REVIEW_FILE"
++++  echo "## 潜在风险分析" >> "$REVIEW_FILE"
++++  echo "" >> "$REVIEW_FILE"
++++  echo "由于审核服务暂时不可用，请人工检查以下风险点：" >> "$REVIEW_FILE"
++++  echo "- 数组越界访问" >> "$REVIEW_FILE"
++++  echo "- 强制解包 nil 值" >> "$REVIEW_FILE"
++++  echo "- 内存泄漏" >> "$REVIEW_FILE"
++++  echo "- 主线程耗时操作" >> "$REVIEW_FILE"
++++fi
++++
++++# 在报告末尾添加完整的 git diff（供查看详情时使用）
++++echo "" >> "$REVIEW_FILE"
++++echo "=================================================================" >> "$REVIEW_FILE"
++++echo "                        完整代码变更" >> "$REVIEW_FILE"
++++echo "=================================================================" >> "$REVIEW_FILE"
++++echo "" >> "$REVIEW_FILE"
++++cat "$DIFF_FILE" >> "$REVIEW_FILE"
++++
++++echo "" >> "$REVIEW_FILE"
++++echo "=================================================================" >> "$REVIEW_FILE"
++++
++++echo "✅ 审核完成，已生成报告文件: last_review_info.txt"
++++echo ""
++++
++++# 修复：更智能的风险统计方法
++++# 首先提取所有风险描述块
++++RISK_BLOCKS=$(echo "$CLEAN_RESULT" | grep -n "风险描述" | cut -d: -f1)
++++
++++# 初始化计数器
++++RISK_COUNT=0
++++HIGH_RISK_COUNT=0
++++MEDIUM_RISK_COUNT=0
++++LOW_RISK_COUNT=0
++++
++++# 如果有风险描述，进行详细统计
++++if [ -n "$RISK_BLOCKS" ]; then
++++    # 计算风险总数
++++    RISK_COUNT=$(echo "$RISK_BLOCKS" | wc -l)
++++    
++++    # 统计每种风险类型
++++    HIGH_RISK_COUNT=$(echo "$CLEAN_RESULT" | grep -A5 "风险描述" | grep -c "严重程度.*高\|高风险")
++++    MEDIUM_RISK_COUNT=$(echo "$CLEAN_RESULT" | grep -A5 "风险描述" | grep -c "严重程度.*中\|中风险")
++++    LOW_RISK_COUNT=$(echo "$CLEAN_RESULT" | grep -A5 "风险描述" | grep -c "严重程度.*低\|低风险")
++++    
++++    # 如果还有其他风险（未明确分类的），都归为中风险
++++    UNCERTAIN_RISK_COUNT=$((RISK_COUNT - HIGH_RISK_COUNT - MEDIUM_RISK_COUNT - LOW_RISK_COUNT))
++++    if [ $UNCERTAIN_RISK_COUNT -gt 0 ]; then
++++        MEDIUM_RISK_COUNT=$((MEDIUM_RISK_COUNT + UNCERTAIN_RISK_COUNT))
++++    fi
++++else
++++    # 如果没有明确的风险描述，尝试其他统计方法
++++    RISK_COUNT=$(echo "$CLEAN_RESULT" | grep -c "风险描述\|风险提示\|发现.*风险\|潜在问题")
++++    
++++    # 如果没有找到任何风险，设置为0
++++    if [ -z "$RISK_COUNT" ] || [ "$RISK_COUNT" -eq 0 ]; then
++++        RISK_COUNT=0
++++        HIGH_RISK_COUNT=0
++++        MEDIUM_RISK_COUNT=0
++++        LOW_RISK_COUNT=0
++++    else
++++        # 如果有风险但没有明确分类，假设都是中风险
++++        MEDIUM_RISK_COUNT=$RISK_COUNT
++++    fi
++++fi
++++
++++# 确保所有值都是数字
++++RISK_COUNT=$((RISK_COUNT))
++++HIGH_RISK_COUNT=$((HIGH_RISK_COUNT))
++++MEDIUM_RISK_COUNT=$((MEDIUM_RISK_COUNT))
++++LOW_RISK_COUNT=$((LOW_RISK_COUNT))
++++
++++# 修复：文件数统计
++++FILE_COUNT=$(echo "$CHANGED_FILES" | wc -w)
++++FILE_COUNT=$((FILE_COUNT))
++++
++++# 调试：显示统计值
++++echo "调试信息 - 风险统计:"
++++echo "  总风险数: $RISK_COUNT"
++++echo "  高风险数: $HIGH_RISK_COUNT"
++++echo "  中风险数: $MEDIUM_RISK_COUNT"
++++echo "  低风险数: $LOW_RISK_COUNT"
++++echo "  变更文件数: $FILE_COUNT"
++++
++++# 初始化用户选择变量
++++CHOICE=""
++++
++++# 修复：专门的审核结果弹窗函数
++++if [ "$IS_MAC" = true ] && [ "$HAS_GUI_SESSION" = true ]; then
++++  # 直接在AppleScript中构建完整消息
++++  CHOICE=$(osascript <<EOF 2>/dev/null
++++    set fileCount to "$FILE_COUNT"
++++    set riskCount to "$RISK_COUNT"
++++    set highRisk to "$HIGH_RISK_COUNT"
++++    set mediumRisk to "$MEDIUM_RISK_COUNT"
++++    set lowRisk to "$LOW_RISK_COUNT"
++++    
++++    -- 清理变量值（确保是纯数字）
++++    set fileCount to (do shell script "echo '" & fileCount & "' | tr -cd '0-9'")
++++    set riskCount to (do shell script "echo '" & riskCount & "' | tr -cd '0-9'")
++++    set highRisk to (do shell script "echo '" & highRisk & "' | tr -cd '0-9'")
++++    set mediumRisk to (do shell script "echo '" & mediumRisk & "' | tr -cd '0-9'")
++++    set lowRisk to (do shell script "echo '" & lowRisk & "' | tr -cd '0-9'")
++++    
++++    -- 如果为空则设为0
++++    if fileCount is "" then set fileCount to "0"
++++    if riskCount is "" then set riskCount to "0"
++++    if highRisk is "" then set highRisk to "0"
++++    if mediumRisk is "" then set mediumRisk to "0"
++++    if lowRisk is "" then set lowRisk to "0"
++++    
++++    -- 验证风险总数等于各类风险之和
++++    set totalRisks to (highRisk as integer) + (mediumRisk as integer) + (lowRisk as integer)
++++    if totalRisks ≠ (riskCount as integer) then
++++        -- 如果不匹配，调整风险总数
++++        set riskCount to (totalRisks as string)
++++    end if
++++    
++++    -- 构建消息
++++    set msgLines to {}
++++    set end of msgLines to "代码审核完成"
++++    set end of msgLines to "变更文件数: " & fileCount
++++    set end of msgLines to "发现风险数: " & riskCount
++++    
++++    if (highRisk as integer) > 0 then
++++        set end of msgLines to "  - 高风险: " & highRisk
++++    end if
++++    
++++    if (mediumRisk as integer) > 0 then
++++        set end of msgLines to "  - 中风险: " & mediumRisk
++++    end if
++++    
++++    if (lowRisk as integer) > 0 then
++++        set end of msgLines to "  - 低风险: " & lowRisk
++++    end if
++++    
++++    -- 如果没有找到风险类型，显示一个通用提示
++++    if (highRisk as integer) = 0 and (mediumRisk as integer) = 0 and (lowRisk as integer) = 0 and (riskCount as integer) > 0 then
++++        set end of msgLines to "  - 请查看详细报告了解风险分类"
++++    end if
++++    
++++    set end of msgLines to "审核报告已保存到: last_review_info.txt"
++++    
++++    -- 合并所有行
++++    set AppleScript's text item delimiters to return
++++    set theMessage to msgLines as text
++++    set AppleScript's text item delimiters to ""
++++    
++++    set theResult to display dialog theMessage ¬
++++        buttons {"查看详情", "取消提交", "继续提交"} ¬
++++        default button "查看详情" ¬
++++        with title "代码审核结果" ¬
++++        with icon caution
++++    return button returned of theResult
++++EOF
++++  )
++++  DIALOG_EXIT_CODE=$?
++++
++++  # 如果 osascript 失败（无 GUI 环境），降级到命令行交互
++++  if [ $DIALOG_EXIT_CODE -ne 0 ] || [ -z "$CHOICE" ]; then
++++    echo "⚠️  无法显示弹窗（可能处于无 GUI 环境），使用命令行交互"
++++    CHOICE=""
++++  fi
++++fi
++++
++++# 如果弹窗成功，处理用户选择
++++if [ -n "$CHOICE" ]; then
++++    case "$CHOICE" in
++++      "继续提交"|*"继续提交"*)
++++        echo ""
++++        echo "✅ 已批准提交"
++++        echo ""
++++        exit 0
++++        ;;
++++      "取消提交"|*"取消提交"*)
++++        echo ""
++++        echo "❌ 已阻断提交"
++++        echo ""
++++        echo "请修复问题后重新提交"
++++        exit 1
++++        ;;
++++      "查看详情")
++++        # 打开审核报告文件（macOS）
++++        if [ "$IS_MAC" = true ]; then
++++          open "$REVIEW_FILE"
++++        else
++++          # Linux 使用 xdg-open
++++          xdg-open "$REVIEW_FILE" 2>/dev/null || echo "请手动打开文件: $REVIEW_FILE"
++++        fi
++++        echo ""
++++        echo "已打开审核报告，请查看后决定是否提交"
++++        
++++        # 等待一小段时间，确保文件已打开
++++        sleep 1
++++        
++++        # 重新显示弹窗，让用户选择是否提交
++++        if [ "$IS_MAC" = true ] && [ "$HAS_GUI_SESSION" = true ]; then
++++          FINAL_CHOICE=$(show_macos_dialog \
++++          "审核报告已打开\n请查看 last_review_info.txt 文件后，决定是否继续提交代码" \
++++          "代码审核 - 确认提交" \
++++          "\"取消提交\", \"继续提交\"" \
++++          "继续提交")
++++        else
++++          FINAL_CHOICE=""
++++        fi
++++        
++++        # 处理最终选择
++++        case "$FINAL_CHOICE" in
++++          "继续提交"|*"继续提交"*)
++++            echo ""
++++            echo "✅ 已批准提交"
++++            echo ""
++++            exit 0
++++            ;;
++++          "取消提交"|*"取消提交"*)
++++            echo ""
++++            echo "❌ 已阻断提交"
++++            echo ""
++++            echo "请修复问题后重新提交"
++++            exit 1
++++            ;;
++++          *)
++++            # 如果弹窗失败，降级到命令行交互
++++            echo ""
++++            echo "⚠️  弹窗显示失败，使用命令行交互"
++++            echo ""
++++            echo "================================================================="
++++            echo "请查看审核报告 last_review_info.txt，然后决定是否继续提交："
++++            echo "================================================================="
++++            echo ""
++++            echo "输入命令："
++++            echo "  1) yes  - 继续提交（审核报告将保留）"
++++            echo "  2) no   - 阻断提交（审核报告将保留）"
++++            echo ""
++++
++++            # 询问用户决定
++++            while true; do
++++              printf "你的选择 (yes/no): "
++++      read choice
++++              # 去除首尾空格
++++              choice=$(echo "$choice" | xargs)
++++              
++++              # 如果输入为空，跳过本次循环
++++              if [ -z "$choice" ]; then
++++                echo ""
++++                echo "提示： 请输入 yes 或 no， 或按 ctrl+c 取消"
++++                echo ""
++++                continue
++++              fi
++++              
++++              case "$choice" in
++++                yes|y|Y|YES)
++++                  echo ""
++++                  echo "✅ 已批准提交"
++++                  echo ""
++++                  exit 0
++++                  ;;
++++                no|n|N|NO)
++++                  echo ""
++++                  echo "❌ 已阻断提交"
++++                  echo ""
++++                  echo "请修复问题后重新提交"
++++                  exit 1
++++                  ;;
++++                *)
++++                  echo "提示： 请输入 yes 或 no， 或按 ctrl+c 取消"
++++                  echo ""
++++                  ;;
++++              esac
++++            done
++++            ;;
++++        esac
++++        ;;
++++      *)
++++        echo ""
++++        echo "❌ 已取消操作"
++++        exit 1
++++        ;;
++++    esac
++++fi
++++
++++# 如果弹窗失败或未选择，使用命令行交互
++++if [ -z "$CHOICE" ]; then
++++  # 检查标准输入是否可用（是否是交互式终端）
++++  if [ ! -t 0 ]; then
++++    echo ""
++++    echo "⚠️  标准输入不可用，无法使用命令行交互"
++++    echo ""
++++    echo "请手动检查审核报告: $REVIEW_FILE"
++++    echo ""
++++    
++++    # 如果设置了允许非交互式提交的环境变量，则允许提交
++++    if [ "$ALLOW_NONINTERACTIVE_COMMIT" = "1" ]; then
++++      echo "✅ 检测到 ALLOW_NONINTERACTIVE_COMMIT=1，允许非交互式提交"
++++      exit 0
++++    else
++++      echo "如需继续提交，请使用以下命令之一："
++++      echo "  1) ALLOW_NONINTERACTIVE_COMMIT=1 git commit -m \"your message\""
++++      echo "  2) git -c core.hooksPath=/dev/null commit -m \"your message\"  (临时禁用 hook)"
++++      echo ""
++++      echo "❌ 阻断提交（标准输入不可用）"
++++      exit 1
++++    fi
++++  fi
++++
++++  echo ""
++++  echo "================================================================="
++++  echo "请查看审核报告 last_review_info.txt，然后决定是否继续提交："
++++  echo "================================================================="
++++  echo ""
++++  echo "输入命令："
++++  echo "  1) yes  - 继续提交（审核报告将保留）"
++++  echo "  2) no   - 阻断提交（审核报告将保留）"
++++  echo ""
++++
++++  # 询问用户决定
++++  while true; do
++++    printf "你的选择 (yes/no): "
++++    read choice
++++    # 去除首尾空格
++++    choice=$(echo "$choice" | xargs)
++++
++++    # 如果输入为空，跳过本次循环
++++    if [ -z "$choice" ]; then
++++      echo ""
++++      echo "提示： 请输入 yes 或 no， 或按 ctrl+c 取消"
++++      echo ""
++++      continue
++++    fi
++++
++++    case "$choice" in
++++      yes|y|Y|YES)
++++        echo ""
++++        echo "✅ 已批准提交"
++++        echo ""
++++        exit 0
++++        ;;
++++      no|n|N|NO)
++++        echo ""
++++        echo "❌ 已阻断提交"
++++        echo ""
++++        echo "请修复问题后重新提交"
++++        exit 1
++++        ;;
++++      *)
++++        echo ""
++++        echo "提示： 请输入 yes 或 no， 或按 ctrl+c 取消"
++++        echo ""
++++        ;;
++++    esac
++++  done
++++fi
++++
++++# 清理临时文件
++++rm -f "$DIFF_FILE" "$TEMP_RESULT" "$TEMP_PID"
+ +
+-+# 清理临时文件
+-+rm -f "$DIFF_FILE" "$TEMP_RESULT" "$TEMP_PID"
+++=================================================================
+ 
+ =================================================================
 
 =================================================================

=================================================================
